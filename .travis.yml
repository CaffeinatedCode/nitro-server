language: node_js
node_js:
- node
branches:
  only:
  - master
addons:
  apt:
    sources:
    - ubuntu-toolchain-r-test
    packages:
    - gcc-4.8
    - g++-4.8
env:
  global:
  - PUBLIC_KEY=|1|IA2SQQTBrCJ9cdgkr6xSA2In//E=|iB5tLmY0zy6sgMLYVO0XgjbriMo= ecdsa-sha2-nistp256
    AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBETNX3MY2iEuao+TO8k5AVxa0Shw0+tjfp6IYRH6cOVNgaXjBV4QsngOGt8kqk48qhSLGfdPRpoK520HvwtudMw=
  - NODE_ENV=travis CXX=g++-4.8
  - CC_TEST_REPORTER_ID=fdd47ebee1738494b7955ca315f8597e70470747862a1e60aff068497c4cd289
  - secure: MrhkfUEJb2jrgI5rPn2+u3ax6soBCIqngvRAC6zPq5yRqU6HS50nkRJKKsQ18mpXgFyWHACrC2EKM0yyUPrVokjcI/p+KotNbx1PtVRI64DcHwP50j1dGhWon3NAJJUfqH3Yb/K2wOzgjXi1qof6RooF0wzHsAJP3FXkbo/1YuQ=
  - secure: Ryd/84crFhn8dzBynwYKP834lLmHkTEQggyzYMDr2CZQ5wfs2Ut2PCsk1fXNVuAOSE3Q2PXIx6JnuL/zCcKK+rAH4akjyCppZYRKSMKlYvPX7Q/BQav3vpQ6RKhpCr6dGXhqsJj68S3eWl2bHyzBfo6jhlMZaB15bNc53D1ASqo=
  - secure: NAO+Hgm2zHhhaEuOobvA5CIEG7BrP7dB3NePeI3RN8eHhF9lWYsklfZSdhw2csnS/LtJfnexWeAfERYagCRwSfA6KGRoUCRmlREVpPjsZ6u1yS5qzpmdTD1rlAXhjWCC52t0xk0cnRHhfQ1SW9O4afaZudzM6L8lRcKeFyrwbDw=
sudo: required
services:
- postgresql
- docker
before_install:
- openssl aes-256-cbc -K $encrypted_8c436ca8c42b_key -iv $encrypted_8c436ca8c42b_iv
  -in deploy_rsa.enc -out deploy_rsa -d
- docker build ./ -t dymajo/nitro-server:latest
before_script:
- curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
- chmod +x ./cc-test-reporter
- "./cc-test-reporter before-build"
- psql -c 'create database nitro_travis;' -U postgres
- npm run migrate
after_script:
- "./cc-test-reporter after-build --exit-code $TRAVIS_TEST_RESULT"
before_deploy:
- echo $PUBLIC_KEY >> $HOME/.ssh/known_hosts
- openssl aes-256-cbc -K $encrypted_<...>_key -iv $encrypted_<...>_iv -in deploy_rsa.enc
  -out /tmp/deploy_rsa -d
- eval "$(ssh-agent -s)"
- chmod 600 /tmp/deploy_rsa
- ssh-add /tmp/deploy_rsa
deploy:
- provider: script
  script: npm run docker-push-master
  on:
    branch: master
- provider: script
  script: npm run ssh-remote
  on:
    branch: master
