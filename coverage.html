intializing
[33m[Socket][0m A new guest has connected

 user.auth(404,"371d39a0bab1022432cee0a4b5f9cb8b7d8c16a89aaba98304f179f321565ea1").fn(0)
[33m[Socket][0m A user has been authenticated
Jandal.fn_0(null,true)

 list.update({"id":1,"tasks":[1,1]}).fn(75)
[32m[user][0m [list] does not own 1
err_no_row
Jandal.fn_75(true)

 list.update({"id":2,"name":"oopsimccusbp"}).fn(37)
[32m[user][0m [list] does not own 2
err_no_row
Jandal.fn_37(true)

 list.create({"id":1,"name":"uwkibvtypchivhrx","tasks":[0,1,2,1]}).fn(100)
Jandal.fn_100(null,1005)

 list.destroy({"id":1}).fn(35)
[32m[user][0m [list] does not own 1
err_no_row
Jandal.fn_35(true)

 list.destroy({"id":1005}).fn(20)
Jandal.fn_20(null)

 task.destroy({"id":1005,"date":0}).fn(6)
[32m[user][0m [task] does not own 1005
err_no_row
Jandal.fn_6(true)

 list.update({"id":1}).fn(83)
[32m[user][0m [list] does not own 1
err_no_row
Jandal.fn_83(true)

 list.update({"tasks":[1005,0,1],"id":2}).fn(52)
[32m[user][0m [list] does not own 2
err_no_row
Jandal.fn_52(true)

 pref.update({"language":"qontuenlccxsarffe","dateFormat":"rdqu"}).fn(84)
Jandal.fn_84(null)

 list.destroy({"id":1,"name":"nerpvfifsfnsy","tasks":[1005,1,1,1,2,2,1,2,1]}).fn(62)
[32m[user][0m [list] does not own 1
err_no_row
Jandal.fn_62(true)

 task.create({"id":1,"listId":1,"date":0,"name":"gkrj","notes":"","priority":1,"completed":40939}).fn(14)
[32m[user][0m [list] does not own 1
Jandal.fn_14(true)

 task.destroy({"name":"hqegqezebxxqcfjkrhcku","notes":"","priority":2,"id":2}).fn(97)
[32m[user][0m [task] does not own 2
err_no_row
Jandal.fn_97(true)

 list.create({"id":2,"name":"vmgfm","tasks":[1,1,0,1,1,1]}).fn(88)
Jandal.fn_88(null,1006)

 pref.update({"language":"wnwfsbyfw","weekStart":76,"dateFormat":"uamnipx","confirmDelete":95,"moveCompleted":76}).fn(76)
Jandal.fn_76(null)

 pref.update({"night":67,"language":"vuicqdo","weekStart":30,"dateFormat":"ekvzozktddlzvfseukd"}).fn(85)
Jandal.fn_85(null)

 list.destroy({"id":0,"name":"kyfqi","tasks":[1006,1,1006,1,0]}).fn(60)
[32m[user][0m [list] does not own 0
err_no_row
Jandal.fn_60(true)

 pref.update({"sort":26,"dateFormat":"ih","confirmDelete":95}).fn(18)
Jandal.fn_18(null)

 pref.update({"sort":80,"moveCompleted":75}).fn(28)
Jandal.fn_28(null)

 task.update({"id":1005,"listId":1,"date":0,"priority":2}).fn(88)
[32m[user][0m [task] does not own 1005
err_no_row
Jandal.fn_88(true)

 list.update({"id":2}).fn(16)
[32m[user][0m [list] does not own 2
err_no_row
Jandal.fn_16(true)

 list.update({"id":2,"tasks":[1,2,2,1,1005,1006,1005,1005,2]}).fn(82)
[32m[user][0m [list] does not own 2
err_no_row
Jandal.fn_82(true)

 list.update({"name":"kxnboejwbngjvxor","id":1005}).fn(47)
[32m[user][0m [list] does not own 1005
err_no_row
Jandal.fn_47(true)

 list.create({"id":1005,"name":"gvhrmjgiuisni","tasks":[2,1006,2,1,1,0,2]}).fn(37)
Jandal.fn_37(null,1007)

 pref.update({"sort":80,"language":"knfvtyco","weekStart":71,"confirmDelete":62,"moveCompleted":29}).fn(80)
Jandal.fn_80(null)

 pref.update({"language":"rgcx","weekStart":47,"dateFormat":"geqxzomyboei","moveCompleted":89}).fn(12)
Jandal.fn_12(null)

 list.update({"id":0,"name":"fb","tasks":[1006,2]}).fn(75)
[32m[user][0m [list] does not own 0
err_no_row
Jandal.fn_75(true)

 pref.update({"sort":75,"dateFormat":"xrhd","moveCompleted":52}).fn(64)
Jandal.fn_64(null)

 task.update({"id":1,"listId":1,"date":36221,"name":"egrmyhkxsdjdqchyxoh"}).fn(91)
[32m[user][0m [task] does not own 1
err_no_row
Jandal.fn_91(true)

 task.update({"date":35128,"name":"mpnskcfh","notes":"vi","priority":1,"completed":0,"id":1}).fn(39)
[32m[user][0m [task] does not own 1
err_no_row
Jandal.fn_39(true)

 list.update({"id":1005,"tasks":[2,1,1006,1006,1,1005,1005]}).fn(74)
[32m[user][0m [list] does not own 1005
err_no_row
Jandal.fn_74(true)

 pref.update({"sort":31,"dateFormat":"etrhds"}).fn(99)
Jandal.fn_99(null)

 list.destroy({"name":"adn","tasks":[1,1,1006,1005,1],"id":1005}).fn(37)
[32m[user][0m [list] does not own 1005
err_no_row
Jandal.fn_37(true)

 task.update({"id":2,"date":0,"name":"sbcpwnupciommjut","completed":42577}).fn(41)
[32m[user][0m [task] does not own 2
err_no_row
Jandal.fn_41(true)

 pref.update({"sort":26,"night":55,"language":"rnya","weekStart":65,"dateFormat":"lyfireqmjok"}).fn(54)
Jandal.fn_54(null)

 list.update({"id":0}).fn(8)
[32m[user][0m [list] does not own 0
err_no_row
Jandal.fn_8(true)

 list.create({"id":1,"name":"vy","tasks":[2,1007,1006,1,1005,2,2,1006]}).fn(54)
Jandal.fn_54(null,1008)

 pref.update({"sort":48,"night":69,"weekStart":2,"confirmDelete":8,"moveCompleted":43}).fn(10)
Jandal.fn_10(null)

 list.destroy({"id":1008}).fn(52)
Jandal.fn_52(null)

 list.update({"id":1005,"name":"kqkvgwrgutq","tasks":[1008,1006,2,1005,1]}).fn(4)
[32m[user][0m [list] does not own 1005
err_no_row
Jandal.fn_4(true)

 list.update({"id":1008,"tasks":[1005,1006,1008,1,1008,1007,1005,2,1]}).fn(33)
[32m[user][0m [list] does not own 1008
err_no_row
Jandal.fn_33(true)

 list.create({"id":1006,"name":"cxyblpjt","tasks":[1,0,2,2,1,0,1007,1006]}).fn(43)
Jandal.fn_43(null,1009)

 pref.update({"night":97,"language":"lfrpcqjdjhpibo","dateFormat":"ujxkgib","confirmDelete":75}).fn(72)
Jandal.fn_72(null)

 pref.update({"sort":70,"dateFormat":"tgdklhv"}).fn(68)
Jandal.fn_68(null)

 pref.update({}).fn(40)
Jandal.fn_40(null)

 task.update({"id":1007,"notes":"","priority":2}).fn(39)
[32m[user][0m [task] does not own 1007
err_no_row
Jandal.fn_39(true)

 list.destroy({"tasks":[1005,2,1005,1,1007,2,1005,1008,1005],"id":1007}).fn(98)
Jandal.fn_98(null)

 list.create({"id":1,"name":"trghqceihnvj","tasks":[1008,1005,1]}).fn(52)
Jandal.fn_52(null,1010)

 task.update({"listId":1009,"date":11850,"name":"mkiotivdatxx","notes":"","id":1009}).fn(32)
[32m[user][0m [task] does not own 1009
err_no_row
Jandal.fn_32(true)

 task.destroy({"id":1009,"listId":2,"notes":"","priority":0}).fn(39)
[32m[user][0m [task] does not own 1009
err_no_row
Jandal.fn_39(true)

 pref.update({"sort":26,"night":78,"dateFormat":"jsjf","confirmDelete":51,"moveCompleted":64}).fn(22)
Jandal.fn_22(null)

 list.create({"id":1,"name":"wqfuuwbihvnlbdqpg","tasks":[1010,1,1005,1009,2]}).fn(5)
Jandal.fn_5(null,1011)

 task.create({"id":1006,"listId":1008,"date":0,"name":"levbgjunpnudqimklhu","notes":"","priority":2,"completed":11909}).fn(26)
[32m[user][0m [list] does not own 1008
Jandal.fn_26(true)

 pref.update({"sort":99,"night":84,"language":"weapwvxsejx","confirmDelete":52,"moveCompleted":10}).fn(75)
Jandal.fn_75(null)

 list.destroy({"id":2,"tasks":[1005,1008,0,1009,1005,1006,2]}).fn(16)
[32m[user][0m [list] does not own 2
err_no_row
Jandal.fn_16(true)

 list.create({"id":1,"name":"pvnhjknurow","tasks":[1006,2,1011,1008,1009,1008,2,1010,2]}).fn(13)
Jandal.fn_13(null,1012)

 list.update({"id":1011,"name":"yffydqhowkkgzd"}).fn(41)
Jandal.fn_41(null)

 list.update({"id":1010,"name":"szyxwanlhrofo","tasks":[1006,1007]}).fn(69)
[31m[Sync][0m [list] [update] TODO: Handle list.tasks
[TypeError: Cannot convert null to object]
Jandal.fn_69(true)

 list.destroy({"id":1010}).fn(7)
Jandal.fn_7(null)

 task.update({"date":41435,"completed":0,"id":1009}).fn(43)
[32m[user][0m [task] does not own 1009
err_no_row
Jandal.fn_43(true)

 list.update({"id":1}).fn(17)
[32m[user][0m [list] does not own 1
err_no_row
Jandal.fn_17(true)

 task.update({"id":1009,"name":"qmln","notes":"qtkauegmcjdef","completed":26466}).fn(60)
[32m[user][0m [task] does not own 1009
err_no_row
Jandal.fn_60(true)

 pref.update({"dateFormat":"cwdmlfhykby","confirmDelete":19}).fn(27)
Jandal.fn_27(null)

 list.update({"name":"pjkvkycdsahgmzdtpx","id":2}).fn(22)
[32m[user][0m [list] does not own 2
err_no_row
Jandal.fn_22(true)

 list.destroy({"id":1012,"name":"ofoflbqjbdibzh"}).fn(74)
Jandal.fn_74(null)

 list.update({"id":1010,"tasks":[1007,1011,1007,1,1,1010,1011]}).fn(81)
[32m[user][0m [list] does not own 1010
err_no_row
Jandal.fn_81(true)

 task.update({"id":1009,"listId":1007,"date":0,"notes":""}).fn(35)
[32m[user][0m [task] does not own 1009
err_no_row
Jandal.fn_35(true)

 pref.update({"night":64,"weekStart":60,"dateFormat":"nfplxxiprlfrrdbfnbl"}).fn(65)
Jandal.fn_65(null)

 list.update({"id":1008,"name":"o"}).fn(83)
[32m[user][0m [list] does not own 1008
err_no_row
Jandal.fn_83(true)

 task.update({"listId":1011,"notes":"iegfmepwzcowd","completed":19534,"id":1}).fn(42)
[32m[user][0m [task] does not own 1
err_no_row
Jandal.fn_42(true)

 list.update({"name":"jtnujklqkbsgcd","id":1010}).fn(42)
[32m[user][0m [list] does not own 1010
err_no_row
Jandal.fn_42(true)

 pref.update({"sort":54,"language":"jkmvileavti","weekStart":59}).fn(35)
Jandal.fn_35(null)

 list.destroy({"name":"mos","tasks":[1,1,1006,1011,1],"id":1005}).fn(39)
[32m[user][0m [list] does not own 1005
err_no_row
Jandal.fn_39(true)

 pref.update({"sort":100,"dateFormat":"cmxjyqausyjknhbl","moveCompleted":39}).fn(59)
Jandal.fn_59(null)

 list.create({"id":1009,"name":"rsiwjdbrwf","tasks":[1008,0,1008,1008,1009,0,1011,1009,1009]}).fn(1)
Jandal.fn_1(null,1013)

 list.update({"id":1005}).fn(67)
[32m[user][0m [list] does not own 1005
err_no_row
Jandal.fn_67(true)

 pref.update({"night":83,"language":"sehxqhldncjvkqf","weekStart":93,"dateFormat":"qbcjhkvbjnpnr","confirmDelete":83,"moveCompleted":95}).fn(77)
Jandal.fn_77(null)

 task.update({"id":1005,"listId":1008,"date":947,"name":"xylcehchwole","priority":1,"completed":61425}).fn(68)
[32m[user][0m [task] does not own 1005
err_no_row
Jandal.fn_68(true)

 task.destroy({"listId":1007,"date":22589,"id":1007}).fn(94)
[32m[user][0m [task] does not own 1007
err_no_row
Jandal.fn_94(true)

 pref.update({"sort":84,"dateFormat":"gs","moveCompleted":53}).fn(77)
Jandal.fn_77(null)

 list.destroy({"id":1006}).fn(99)
Jandal.fn_99(null)

 pref.update({"night":84,"weekStart":21,"confirmDelete":68,"moveCompleted":21}).fn(71)
Jandal.fn_71(null)

 list.update({"id":1,"name":"incdivbojktmxqzbvhdhe"}).fn(41)
[32m[user][0m [list] does not own 1
err_no_row
Jandal.fn_41(true)

 list.update({"id":1009,"name":"hionvommdsy","tasks":[1005,1009,1011,1007]}).fn(15)
[31m[Sync][0m [list] [update] TODO: Handle list.tasks
[TypeError: Cannot convert null to object]
Jandal.fn_15(true)

 list.create({"id":1007,"name":"kqjyowdsqafymxbia","tasks":[1008,1010,1009]}).fn(59)
Jandal.fn_59(null,1014)

 task.create({"id":2,"listId":1012,"date":54793,"name":"cyiivdvp","notes":"","priority":1,"completed":37050}).fn(8)
[32m[user][0m [list] does not own 1012
Jandal.fn_8(true)

 list.create({"id":1008,"name":"ohcgooggoee","tasks":[1009,0,2,1012,1009,1008,1013,2]}).fn(88)
Jandal.fn_88(null,1015)

 list.destroy({"tasks":[1011,1008,1006,1011,2,1005,1008],"id":1}).fn(57)
[32m[user][0m [list] does not own 1
err_no_row
Jandal.fn_57(true)

 pref.update({"sort":67,"language":"kty","moveCompleted":77}).fn(62)
Jandal.fn_62(null)

 list.update({"tasks":[1009,1005,1007,1005,1012,1007,1009,1008],"id":1012}).fn(40)
[32m[user][0m [list] does not own 1012
err_no_row
Jandal.fn_40(true)

 list.destroy({"name":"nbxjivbxmrtdkjwev","tasks":[1014,1008,1015,1012,1007,2,0,1014,1012,1,1006],"id":1011}).fn(78)
Jandal.fn_78(null)

 task.update({"id":1006,"listId":0,"date":0,"priority":2}).fn(86)
[32m[user][0m [task] does not own 1006
err_no_row
Jandal.fn_86(true)

 list.destroy({"name":"uboigcyhqwqeaqhbbt","tasks":[1006,1013,1012,1010,1006,1013,2,1012,1007,1010,1010],"id":1010}).fn(27)
[32m[user][0m [list] does not own 1010
err_no_row
Jandal.fn_27(true)

 list.create({"id":1009,"name":"vmkvuqkafkq","tasks":[1006,2,1012,1010,1006,2,1007,1013,1009]}).fn(95)
Jandal.fn_95(null,1016)

 pref.update({"language":"jodxfptqd","dateFormat":"irixlyvgoagbgreh","confirmDelete":1}).fn(41)
Jandal.fn_41(null)

 list.destroy({"id":1012}).fn(89)
[32m[user][0m [list] does not own 1012
err_no_row
Jandal.fn_89(true)

 task.update({"listId":1009,"notes":"lvigxzcqjm","completed":95947,"id":1014}).fn(65)
[32m[user][0m [task] does not own 1014
err_no_row
Jandal.fn_65(true)

 task.update({"date":0,"name":"ckrpsqyqw","notes":"","priority":2,"id":1013}).fn(46)
[32m[user][0m [task] does not own 1013
err_no_row
Jandal.fn_46(true)

 task.create({"id":1015,"listId":1007,"date":0,"name":"hyjkoopraxfxbgl","notes":"","priority":1,"completed":66819}).fn(95)
[32m[user][0m [list] does not own 1007
Jandal.fn_95(true)

 pref.update({"sort":44,"night":56,"weekStart":13}).fn(75)
Jandal.fn_75(null)

 list.create({"id":1008,"name":"ivxrwqgjjceobhnwvsktd","tasks":[1014,1010,1006,1011,1013,1012,0,1012,0,1010]}).fn(9)
Jandal.fn_9(null,1017)

 list.destroy({"id":1013}).fn(62)
Jandal.fn_62(null)
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[33m[Socket][0m A new guest has connected
[33m[Socket][0m A user has been authenticated
[32m[Storage][0m Removing user 406
[32m[Storage][0m Removing user 407
[32m[Storage][0m Removing user 408
[32m[user][0m [task] does not own 863
[32m[user][0m [list] does not own 1034
[32m[user][0m [task] does not own 863
[32m[user][0m [list] does not own 1034
[32m[user][0m [task] does not own -200
[32m[user][0m [list] does not own -200
<!DOCTYPE html><html><head><title>Coverage</title><script>

headings = [];

onload = function(){
  headings = document.querySelectorAll('h2');
};

onscroll = function(e){
  var heading = find(window.scrollY);
  if (!heading) return;
  var links = document.querySelectorAll('#menu a')
    , link;

  for (var i = 0, len = links.length; i < len; ++i) {
    link = links[i];
    link.className = link.getAttribute('href') == '#' + heading.id
      ? 'active'
      : '';
  }
};

function find(y) {
  var i = headings.length
    , heading;

  while (i--) {
    heading = headings[i];
    if (y >= heading.offsetTop) {
      return heading;
    }
  }
}
</script>
<style>

body {
  font: 14px/1.6 "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: 0;
  color: #2C2C2C;
  border-top: 2px solid #ddd;
}

#coverage {
  padding: 60px;
}

h1 a {
  color: inherit;
  font-weight: inherit;
}

h1 a:hover {
  text-decoration: none;
}

.onload h1 {
  opacity: 1;
}

h2 {
  width: 80%;
  margin-top: 80px;
  margin-bottom: 0;
  font-weight: 100;
  letter-spacing: 1px;
  border-bottom: 1px solid #eee;
}

a {
  color: #8A6343;
  font-weight: bold;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

ul {
  margin-top: 20px;
  padding: 0 15px;
  width: 100%;
}

ul li {
  float: left;
  width: 40%;
  margin-top: 5px;
  margin-right: 60px;
  list-style: none;
  border-bottom: 1px solid #eee;
  padding: 5px 0;
  font-size: 12px;
}

ul::after {
  content: '.';
  height: 0;
  display: block;
  visibility: hidden;
  clear: both;
}

code {
  font: 12px monaco, monospace;
}

pre {
  margin: 30px;
  padding: 30px;
  border: 1px solid #eee;
  border-bottom-color: #ddd;
  -webkit-border-radius: 2px;
  -moz-border-radius: 2px;
  border-radius: 2px;
  -webkit-box-shadow: inset 0 0 10px #eee;
  -moz-box-shadow: inset 0 0 10px #eee;
  box-shadow: inset 0 0 10px #eee;
  overflow-x: auto;
}

img {
  margin: 30px;
  padding: 1px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  -moz-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  max-width: 100%;
}

footer {
  background: #eee;
  width: 100%;
  padding: 50px 0;
  text-align: right;
  border-top: 1px solid #ddd;
}

footer span {
  display: block;
  margin-right: 30px;
  color: #888;
  font-size: 12px;
}

#menu {
  position: fixed;
  font-size: 12px;
  overflow-y: auto;
  top: 0;
  right: 0;
  margin: 0;
  height: 100%;
  padding: 15px 0;
  text-align: right;
  border-left: 1px solid #eee;
  -moz-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-font-smoothing: antialiased;
  background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGYAAABmCAMAAAAOARRQAAABelBMVEUjJSU6OzshIyM5OjoqKy02NjgsLS01NTYjJCUzNTUgISMlJSc0NTUvMDA6PDwlJyg1NjYoKis2NjYrLS02ODkpKyw0NDYrLC04ODovLzA4Ojo0NDUtLy86OjwjIyU4OTosLS82ODgtLS8hIyQvMTEnKCooKSsrKy0qLCwkJSUnKCkrLCwpKiwwMjIxMzMqLC0tLS0pKissLC00NTYwMDIwMTQpKysoKSovMDEtLzA2OTkxMzUrKywvLy8qKyszNTY5OzsqKiw6OjswMDExNDUoKiozNDUvMDIyNDY1Njg2Njk5OTozMzU0NjY4ODkiIyUiIyQ4OTkuMDEmKCowMjQwMTErLS4qKywwMTMhIiMpKiopKy0tLjAkJScxNDQvLzExNDYyNDQmKCk5OTslJig5OjskJSYxMzQrLS8gISIwMTIoKCk1NTUlJSUnJygwMDA4ODgiIiMhISI8PDw6Ojo5OTkpKSojIyQ7OzsyMjIpKSssLCw6Ozw1NjlrfLakAAAg2UlEQVR42jR6i3ea6rYvPgANIAhVXh8WvkQlioUiFlFcBtAmoiRNdzxqu9p0J7vrdK29zuPeex77nnvO/35n1r1ndHRktI0jTOacv/l7lCBK5UqVpOha/YxmWK7BC4TQFKVXrbYsnimqxuuMVlOQ0XltWjUdCwRJ1M+tC1KudOs9q6+da2adUewG0SC0SwELfHtgDds93VEuydEbl3QMWeNoYkR7b/0x1ZRobGI3mLwzAhePqTAwhg6aogjNsGy7/jwQ4rkdqe7CWLxF8k9LfMVFyRS7VJqtkrW8Vt/bkR8FZJao16ipknbC3Yw2lM7laO6HBEOadEZ2tpf65c4v8e3u7FyU6qbiNNyCuzXZ6pawgnwgmrpTT/Q7w2EZmiIJ0dzWDI7mhQ80IfRnMu2kzA5r5r1pIFoia+/d93HRYp1GV8TbrkWoU/+jdI0Ff6yGwTjT1Hn8J+8m1rKpGiYPuNiHnMtNMIv+zpsk84MYTNW1/+DpwXLvckdOCMYowVNPREe0QlM8xRHXXFhcNDzupwsSmb5pH+0t0RP2Qk+QtI7F1Qm6JRC6ZPBtPq/dq/kH+jxtCljn9TIpW6rQIgmSVyj6lPICIw4N/taka41PFUInth0je9+jO6Kt1G4/a7V2LEgG02B0pHVuCZrgltSKMuIl5SyufUv9mYuQi+mFgzbBEtFo2g+Dh4sSTrLNu8JPh00sQydpb00tqXBvqRN7Q7kqzcnIxCGnvZt/WmJacoOEO6Dcn8Qre03pOCSQxbMOXUuDNx9SxuLz4W1I18gvjViQ67zV0rxdWL8Te/TQkuo8STS41DR48W7L6YP2uWIqiUV8rd6Gbf/rnegKZeG8TpAM6afhGze9JAOxbLjsnUXEbrZ9vLYd7MT32cPF5mKKxmjy7huaoD9n62GOxni3iIJwv0IzZAZjdZkUtolCNLVfYZNaquFjGszVVf+J0vrz4CawoKdHnOzb0NMH7CDBOybfYNJ4rfeMyFNjkFYVTzMFs87rnPGXLUOeNKRVc0LnU7/UIgelzsy3CMuth0YfvnY0wsD3vODUL3eJcKqHQpm8yM3XZQWJxO6Un9iYloyyLpOwN2obHy6W6gbpcb44XmyC+mg+itAcaprGcrwZCqMj/GmtKn0zPvpTz/Cv1dw21XwP3cRupg3H3MF/S71eTKj1YrdwKdc2Mw0fRmb2sFf8lW3aU6JbIZSEPqvXvjM7G/aApyXlXeqKfMq0g/Su3rUGJPSPrtGElgknrZM3xUXqsAP6zMCNVn5u8aJnSNpJv2uru7t2jfRziW2+GuhqfldUNbPk71olwo+46ePUo1U3WKk/e5YK07F/wGRgcpODmQnIlVeHCWBE4puBi2jq28UKpqiN1/4UOrGz59TNYrrQHtd+11sG40BGD+pXdelNqGOg4NXe8W4eacJV/NS9/2Umtym6WQqveqR9xdCMElpxnbkalM4Vf9uaEcWZaKdyibEIjWKxJZPN95niCL3GiaXyssIrHxoLkqkzLCXULN46/f2h3tQJgyip+Tk9EAjJ9aJshq7t8X45aowSKspMSvPf7r9R8yxNptIaHS5ozuEm6luPDApugyNP8OaqiQ4BjaequXA54SLC83eHIY2r+CZp4409Xqw8Aa2oI7XkCrQi+in0w5AqF/kLNrcUz+qkl/lAobY1jSnx5OJNhyXIz3qfNFlXc0TKaglNwdWkWYt9QQ1Kr6W8zue21iNrdJk+N5oCr2O9nEtWKC7IS5J/zdDEYrmnAYfg6agCy+qcgz7ZofeDc4PbUWSvkshWuAc7OjiUyLkj+RAtdlwXJcjxdpkTTHDhK8lBCi8+JtvDVL1W6elmOM++YS0LuSlaP1oUvAeiW3cFnvTr8EbTz1tsSMYdGeZe40sRWu5uAfj7q+ZoKv2FNQ0p5XY1lmlcigHZqTPpabufEVrNuNPi165w3uCVQJHyJqmSJ7ZHnguqwtCmwViIJijj04ba2JNYtB+yORf5gg1/9t9iw4vUpeqiunSAbf+IBdj/b+iG2qrHvuNP0Vd/+ThVZT/lrvHYjjgDbbyxaqgHNM2uhxa1GW3UedZYhMMwM4mQhltouK+IV4NdbIQNM+8Yv311RZk9kT4tiYR4LkyFcuPpdcjuhUuFqBAWRZa11lcZ3gEBlXywsNhrt+plISZP5DlsV9l4EgY6J3yZPTUcMrgaWAT3oI79eSbGEbcJpr6BD8kyDiVt+G0/hXosQN4NFXKlfWIfsIs0BHODVok1/IGnKFHJYIquh8Xo+2+bkQNTGgWmN/fZ0Y33LSj6lr1GyV7mWIKg7ZTRZPGuhF/zjRNcQ1UPtSYgnWQxSs0yrVhwNDcdGMNSNe2JT3WuzbAM3HykyAajS3Uphf6STKEqxLas9EnmnhA/lyj9Uj+JoY7SVgVmGLl46Rm2u98sbkap2lzAdKBG4r6LgulQOSSjQv1GWdQ0jtDUK/mAaqM1Uqjpu4k3Rvfvxv7YTxLSK+wN3E5jVIzmF23uZ7hiH/sVP49D7tvoKp4S8b1LuvRlivVB/algbhcFITYVXvDpLzpDfplR2uD5V4XJFxpjmIpLc9Y5sB2TpBRix7Bme6GZIq+06v3XzNeTcA4obQIKxrnT4C2JpOqD92dbmSX8MGazly5EsZVMvSU1f4RZwyu8iQXbVdeLlZrjuTT1jrY1uk5c7iZ7RsvhhluqAkq4JpVQAg7RJFtSu+xgJ8Pv6O1j5DkLxT8mkbfyRW5DrQmG7hiDIjCgBsADbjuof6YHLGeV6a5Q1Smx9joUXPpdaaDx97A/Wq00oJkdR7ZYuQRfS533JtxO1erduqWOYIt3wh0wpbLuCNIYkwxbswbikCUu2CDCS+Q+7rgVtfRcm+SOcdKPRlZ/rE7wNVUEE39KTS5uvUKN1PUnkloPkyzhyGQ8qkouEjJ3H/VXdqG6asSRiw3ecMlBvDDt8dDhBHXMwZ2Cajzjr7/76T+IavqPYvz6r7//E/3X3+N//h/0QozbjPgPiir69P/8X3/9F/yv8b/827/++98WItPu5/Hvwd8YPf5bp/2/lX/T/+Of/0MJ/lYTa+L/Ef+d9vN/3/2T6P/+jyTzu/evf6U7vxN7B6pJkRtAF6jUr8I+P8RsP/ptGhfqFk+pQ/DgAy6NJtRYJdXmp4gK7WLqLKJ+MaKhGjOojvL+SnIWrkpy0SLHDe4QuyNzaEA15mLMCcmE8Em+4HdOihW4/ZWuppJEmzeAwcDtv7MuLc9y2V5atvxXNe3S4DUMt5/Qy2LM9kSYKiVWBuKlfp4nxTntpuW03JbIlkiRvBXmT23g1I2OYe6IizUHPIq6zm6mbfsbteKmi/sg9J+ocQBMctGFO7iljo8TPN+z3jxw4do+ZwfqoR9dkNTKHyM305GpTkfhcHexVkPVGEbUOjuo9f0UMPHBFlGEx0SLvJvVRKTwW7PSew5oPme+E42+frJa9cGt2njS3dK5kIif2eYbhuSEQXEqMVfUjhGIuin0G0/W5ezJyJQy3SpMLai4M0JUWb5u1k9tny5bd1pPwYBpQuDCXZl62xg4CdVEAtflXHs6JKmP/pH6mOl796Lgopj0o8d5kKh00hxG3OSdEE/QBo9Hgr8JJqAeLDwJohG5j/DGh61Rc/+tf22/8kEnxHNCEjo0ElvvGfESZkqmz2BDcKV1H1buSkhkdg7p1IMGs2s17nYjpblrWuE2K9WEO/hcRp5e9oOF/QBmOaDtgil+oaU6szPrdwW65fOB0KUTsVUn7LFU7J8e6cxJIl9+FHw5MQMzuQJ+4oxMH3iW/5GK+hWuG0T+gTLs+fAjdtUd58TmIUq04EeyRCYCjkldow234aIgR5bqwrtZosZ+6YEqAmDqatJ9lWasz4IquKALPtd92hGI3Z2BdzzZue+REl1Om4DIWD+RrtUTOJLI+S0jHowXXdAxsGLSd40zYNuEUlOGhrwL6c7tcOtUOvpJCP7QBQS19H+GvZn05ewjlVLz+IGKoC9TyfQjLMBNmXCuqqtTdOSukZW48B0HqgSTCBrBnlFvF4CG2Su7yFzqmJFURK3UmTT3ru050r0ptUpMilYnBJWfl2Bv6kPlUuE1kxxpdzui9AubsR2N2boVSu81OulAwBqoSr1LZ0LLYOomyZHmjqnXlP72s8LnDouEJjtodBvdHaG1jMySYO7crWd90MpCRyCG14vb5IE7Arupw/y/RcCm/Tm3zK6zYj8PYNaGldiUfkB/LHWcmf2lVM+mwyU27a0qq2tscrQ/vzBjN26DnntIrOyGizzXK35yKQdYnUABkyN4saz3WD/viF+eCcsXnIajdWYJWaYHRstIis9CS+tqnFGmz2j5uzfr3Z4prqgK4XOT/PyftvjZqIm8lhkfxJ7Ol3CJF1piYBGAG8wtAk56Drw1YwmOpcz+NdfkSpSLplRXLXHL0Rquj6YW/gabqgK7Dgr6NwtH0B/AN7XrN+MVJ6AmXmUuqmQulrNNYPmH0RoDogydOKLo/QbfYNARSQQKISRCzRXU+q9WWJFL3LZW6u34CkeG97xC0NNGaJ0bvK6SnZS3zPskr5EtuCgjMWR5o2x5BqhKmDWJPRe7JMEOyRb5uUKlHaGVtq5ivSOaSliSXp9SQm2qk8MRJh10MAp9QQ2H5t59J8rjiwSZtoIfMGjlLPVNdYl/LBR0AO6WLGDmkLkIPRE45Y9MftdAK/yNu1Hn6tzOQTesgQ+8fSzB19wO91vCnO23vOWQdwJ63SJrYjdfKFW6W281PKs2k8iT9ai1cgJ4sa3xqdvmtxR8/+D1B8AKc2u+6JftryRhMWSQtoSBgIyyQGyxcnELuAasXN12oSriU4RMz1DD6RL0TSV+om7i1Yt+jEE/jnawM8cX/UhN4nkiv/w9eALrzNhXuQfOzFL0Fi6SjF7/4Qn8rLYBoa85cvgAnkCEBP+HPbEnquVXCZsMS/yzYw2Vru60P/+nJPYKkzZFjmbykzUoEqV836T5q3fP/L383dF82tx18/AZgZczMAgyeWYKmSZIqtHL+e+O4ZRcq9VI3g/qPeCoiK4pcgEqdbS0S/Be54sbVQOuJVPNBblIghzeasNu7h/g+Sz1IdhI5lCwq1nUb3Ji4OCIcqQZqtqJ5w7rXrg/DA9IgVmEGhDgGecEwnCTHffXcXs0V3OCEVzYDKS1vp/oX+ng+6XVU86UjA6FMO2RXOOOrqY1GgPvrAk9HV/BXtCu5RuwF8qgdGDLsBcui4E33ymdBip1X8uKyhIWT8qNRDsXz+gvO9UiEC0d8RG4Tf2x8H4slljgHtCBcxHLTWOYJm5H/fCPCzOgf9qgOUxTRZ0Pc6ha5yLuLVT9ntvIa6gacE99mCovdUumTQdRP4RPsS9129eEe2uSvvGh0bV4Y3QPPhPZMqhZWSMa5R0Hc1SGO4IVOQc0FrirlibTVfKRrYkD8kz3b+X65/QkUNaZdrdl3mCap0Hf3YcCw/LiouJYNbqz88UqeDYv93yO7vvXtgl4XCyAO4ODkY6W+83+LZU//p3/zXNGGrUKClCiOnL27iJZbNWDF02XXAOeFlB7IaADoMH1Yqr+UP9biyZDEa/iJt4MDeIz6GKTdLVBfWGVtRN4fdT2rgReX8UXwF2zOrradm4J0nyTgdPnai3RvzpZvCKDUqjOwD/QA6EDaMCLewX6QWYVnHY1sx1bd8ovYnPm1ZvPH+rE20lWjOCnZ66/xDt0QAl15FjfBcZp+i9OU0RNPQ0t3x2pSNWo8eiYudwsnuP1Hq6iH1LJCJynkYsfgJ0p3pF6SoQk2l+jqE8CPk+ziGJRSKjs+W5AO185umPdkYzlK4wl7TC9NxyyDP7ZoyYVoXiuS6SjnInlLWrwz1i8bGTKXX0AVQWkSfIlglW3zRJRJ8bg5VgE6ZEnqNu9B++0GNQvDQJvFize4ESNKBJP+8vA3LM4AX5SIBq08Mob+7QMTCZx4nwP/64+4BnlZC+8WtlP/CXw6t1PwMwkJ3jhP1FiXLhDF/3I6FGUzO2DSi9ABxKyyL9paZxSEz40ZCPQToDAJu1959k7QdbVxgB4icsu2s4zsTPJhcEDo+N1GX4zSk/wriRh8AqwL62972i9HJHd1ydaLXVzvKvOfGGw5RVcUVMiKXFH4APdkQU/dc5BX0YfKTNZYXCW9mb8bc8mufoQP6BbdQmT99ZjoYfr/go4TgQX9IDgztim7wyFeGMfbNaeqj8Dzs38pgcqwSv2hbqB3oSGKWKy+sesY7p57wAHldqE6NDudk/W7s/zjrK4rZFlFvaGxnSZdHbc1y47qDN6xkoK8O3bfr2j41dlJZ71rB4dlDqapPFa8N6xBrprUdtenUCHwxKNhw1uuTBh+9uU45k4REpQABN2bAO9DSLqoIL26gNroWgup5pUMxHUNSq4Gyz47vBPvilpo5f9OYI2ddAqTqmnxXERxQJ3UK8fHbVE9HagHi3+tqNRoNsArdmAxHA5LwtQo9ZAaNKUTljnokljo2x8scqVpEEIPc01fPCdHOCg0DeWBz8D5TVAAfx8aRH5X2ZYNI3ebKDZdeJ+oBDAxmRqJ30Eh2/DaeAy5diVNMpEDmXiPDsGTzBLXy8eVDdJoIafgx/gxMyQi454QrW56nCyeELgSuNNEmYkflF+t3CZQOVRWjKhIuCclmQSlAXT3+4JGG75B4t/5hQ+ldMP4LsAW6z3XmU6IJJwpnGVnsgUZhoY1fZlwTR8wSU7xRejf2uCx9Z5trVTRRJP9KnEb134dEieil6eCOGWgboI7xsqsqM99jfJLTePjygKlH2CVxxsse9QRzTBFjD/Kjqitr/CCTBt/SJ6nLxz7cKP9pFqBpp0lN5y+adKNsZjrPuroemZauH9aTTFD3EKHW8S55XBLFQAt1jgxTQCTwxmx/JyfsZDN1RroN3VaxpSenpIX7K+ZbL8VdlQDcI4Cbzg3QJLa9yVqNxUelu+EtxLVqeekaAvSJkO6sSVqbUajxqhKshNpvZqoeApF0k/0P0ikkwUcbdwc4A1ejN7Oo0O15kG7hTMoK3hZRBCX7YYeLW0wvcXx/18n/u37yLgzBYVBUvORGli+sfRcX/74uD6P4hq+7xu54TlWJLFzT63uwUDwuEDdOjJQqx7JV+ZjaEAPi7t0MMrR4Q8Rkf18uxD6RK0RKh0hL8YU+DeL97i4pa5ZSyAfXKwZRS/8gXcxdZXm62RBDj8U3sN8x95b5PpPs/mCBKYvpaA50pN5Ct/499AFTtwQ5vgeSh+NHrKIi4NVpwM/XzRaNfJD856lPE6M21zWPguFsH7jbLVyEDfRmt4VwrhCJ5VTYmcSPfGgO5clfN+vbaDZ7sakU5+2vZ2WCDY031NxJarVytfDDVtiafcTGO2rJ/taoL3zChN2qmjxofczTOYQPPVQPh0JVtYgdUQINcSiNEEy58UdYXX1MpWUCEBx7LbcGtAm8XWRQTVOaoV3ySri4RShhs/B/0m4jX6OAwXOvcA09bNSG4czEGv/Wey6V/jbTCNTW6awXdNTcA1GsPe1E9fZdGl7R0vyoVpIdJtfC6d32NNErrvq/R+d65VG+YOwRXppXxOCYyGNSf1K3x6VxAW/vtz4EC1SgCOSPdN62sLsoIzuDfg8GwZAbquVO8HIuFP/ToVoeUB7nnwMF35a1wK1tI6fkrqFKhQdeJpwyls0pIy8AZde3/6LUUbFaYJthyUJSU/kqDXTLQElnn0Jr4B2RVghNrmNmoEn7pXIeshPguXVsvwoTdmClq49JJU3LWhHyWTrJL9bRP6VKv3tZoA/th77p5Jw++OEENvyvWy/pNeExiDUVQaXIRGh8xySZTI36yueFaSXo1uJY0RnXYgEOoWWOJHeaVuX/bGNhHsh2yinznl/++NJcE9j6fBPRcBdq9hb8awNw8U7Bl6GM7x69EDOIIbX/npZ++amlHR9L/35mE/2Ss4gb0xCcY4VyTFLRE796vHysLAamqcyO+aFQyJIDBNslbH2/MrAvZiSEIedc/cqjmv4fbda2pXbv+F5a2szSsdkm9noiNURXt8edUhGUF6fSZWd1IJaXKFwD+49R6eCXD4Bkef7j9tRtNMVgW8BhRz/Qpy1TmeYk0doyjZoJSbePOReVHgkFsCFuQJ+Lgc4BxeAsK/cOiNDRmdNw0ctYhn/nQ498dYI5znzGLoJi1rav7Cn88rL3wLePVtDK5gl77Tki3gHEsIAQ2+IKgarj7Y8W1IQzV5V9N+0TjLqbg68WfKcOmBCOj3JkwJhVIkwDhc+JorXuZEPMEh0vvH3x7iqf+VAwXgd4diZiaJD1zHL9Snx6Wfg4IugreyhabQkcir+y5XgDtdx3Avs7lkeeCBwDvZoTUCXx5QrZkcEqWfYEiEYRs/EphmRALSNGR1Iclgdr5VFoELpzF4++f35w3/j0t5ucW3n2ch4PQCLuUXupsPRR7UA5FjSKrMtPcKAZJfagO4lGE7FH3YKMjorpK0ZxAv+i2JkJhtAMWWWFej4RhPR/cJ3DxwocCvXDi4SGZU4cu+K32XndiFWgopAl+0GApcwf1XvymJcFs39jExIBO4yUjU9MExBLQYc9H+W7+IgdESPRpciT+rKZPebVtaVq+1GYO/5xTAL3HASjNTGIgMvdjWbgc7JvdE1zIFpuC0U9ESiZyzBixzxWxj4Kwh8My34q+FK3KNLtmsA1qyrmKSNQOXCPUZd+ONelBTvFoUI/CYsqa/RhtKiyMf2CgSFqEPk59Y3uqnlZ8gFpswfSYyko23yVZYxzKGxGm49Zqxg1l8oz5Ra9XaRwHkuxepmgyhm0SoNy2KlbcEqK+9QqS9PNx9Ihm9U7gsR55SSJ1FBDNnkuWKxIZ0SDpXuOGwZdoUbOMDPHP4vBAgz2VlSEJAHZGJVbYIg7l/FO5KfIVvxC8pPPxMGcNMoevFDeStt2iqztE10n2TA4dgJH76YS9HDhKHD3iCx6ieFX84BAI3QQnngh76f5ruPQVbr5qZmck/5UjDc26lfrOvUBWy0Ogl8bCoOkMOns81TnC3cuUS9KW8+9A+fe3XYZOFUPG1u5epSSmDLw0s5s2F0W30ANeo+zJkJQz9SPZgzwYpEoktofhGVfmLOAB20boCbW1QWq/NpET/hnMecw/uSyAH4NJc3ECOU4nnkK1fj3S/i5dwb3R7k00AqQQUwt7Ie1qV0aY/VQX0J8hLPy7eBNXMHYZYDNxHZ2Qh6AuXJxq+AeRec/Q+JLhZV6hpXwQEzw7bf5v9uUf2vpq3qlhmy0IIGTkwYdCfSAFmqbdo+3XvDTDjFJde0mbeQLcn2n31xaAqJ0ixO/CLsT4I4G4DoncVTgRGNBtsCcjISWT+oeXZ4Iedw/8OsJI1aPnNKLX/60VvcZb94uasRxCkqlPQ11u1Sa2hHvB80WQENxVyzjns0/PiEByyil21Te6oisk3mNCEMrhouCFO3yEZTHHOCMy9eb/4Tmi8cVf3Lf7P53SY2hX3PSN033As3ETIMLHWumWEO9JXHA2y2SIBlIPpLGG2qvNsCIlIr+B1SWAqRKm2w6Blf7U+zCSBwJrfHG5i8J5Gax/cVonMlon7aHJX/gSvucIncRP93XCqkv7D8IFKFsLiBgHqUpXhE3pYjEcV1dk/JD9zFVCfEaQIVX8Jmfz7IIofcBKQ4OaG+C3xC2veX9CD+iAFXDNaGg9eTVxvkbJRJlW4Nk9Wk13kn696jWppRDe/8pDrYMO9ZyxZ98ReKSz9kWKLLyk2zCZgAniCkLJVX3n1M9DYbomyahWiv/KixRIV9hj/oFz87I+HLznbPTjpa+D+bZQnMuRsljTpv90vQUt/pK7jCFnA30B/jtroSF2/m/gpWn1aQs5WeA6ghzF8SdqWI20fghdSeDOCSCmLgTkfaGgGDmw7nHFkRzGtag57IHS2na06I+gzEphXo1w/Zx2BM/jKL2nZoFjHggtFQjYi8nSVRSXIE58RPbBObXk7uuIL9+rs/5Zo7suJInEUxgsiZZAWS25iBtpEiZeBgDtghEoAE0sjcayNq85M4tbu/LF5h51335PsGzQ09O875+vUS89lkWMyNOFoip2PuyWyMP/iU2XIZdfCCJNDjebDoBLQdpy7QQZC7s9c0wjHJervQNDu2jWzBW5MSAJMr7bP+Iv92BkS/GGgzjEn7MF1IRKFwwzbjbS4/slGOmhx9cZrFu7HSEefojNv3r0UaKfKOWzXsq1zEugbzlMDFsacRJJI/iJlK3vtkZ+PLZIVMFlKA32wbq2Kd5T0uCLZ1CPkAfCdzkz2EYscjDcZq2AWfziN2covN4kXE1lQXPPLTNM1xx3tbiepcO/t3SWm4w87qfh99SL0ZnY+LKFPLPeXVM2mIIoVWt+9Nk0I7nY4O79iGYqxZ8RVz289an6NVdJWnSKZvJQCAuHNiVaDxPAFoH392t9wot5t0/qmU95eEWNbU2udUW5sN9JVqcYlvAIfLeYC33oUzzxZgSktsv21mA7Uly1FA5VnoJFh6N244Wmv3YJGFv/TCPryaw+ZORlpZjQdq/2DYXr3EZskfed0G61P09ipTKmlTQ1067Rg5+PAk5FlQ9e0SWbGf2B/08kqymOTMVOznsALHHNFH4LFRKl2F/NOiYFl9khNHnSu9Ak5sq26Ynl/i2fdTle29Y1ugqmR5Yj4YT9pvslFyYCbw0mNFr5rVQm1LvkG27QMq9ph3t8fmn6r6SQ4oSbr5tz+J1kIawGzDxb6VYOvvWhobDTXfBeNv3b4aNm5XUinsCGqG2q/45m3+LoCOsddFceYhRx1Tsss9PLdPfJdErFMjYd3gddjiP0+XQjcRadZP6bwNLySvunFf20Czy6JqdEW2a96KxdYdOryBv1BjbuUq2yCHeh+6sk7fGmmPi50pe/1l5TyPe5oHW9oPnhPswLyf2TFDdCyYlhwBCstv5C1HwlW7xWoGT9XZt4qVj5WryLPLLD6h/5cMLEjWzgCeAIKNsLak92aBqBsHl4AJwl2N4jfvbSkBExGimv0nFvv09uDScQbjx+w4kPQjgjlW+g9ws9VEJvI2k8N6XxVu0uIwovgTFdunG24gBtaDi+y1YLQwZ8mwbip5fVlO3k0n0AEr/ETbtu8Vjkm+nNSiEb7X/3fMjBL5A8PdgG+/FnbexbFFExmEfetXAnisEKy5z44WVPpQZjSy/jzeGn4yDRsFGqhh87QPaDBWhlo37IFbe/C0xynS91d2tP/AJoJS0sVF6iwAAAAAElFTkSuQmCC");
}

#menu::after {
  display: block;
  content: '';
  padding-top: 80px;
}

#logo {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(255,255,255,.1);
  font-size: 11px;
  display: block;
  width: 20px;
  height: 20px;
  line-height: 20px;
  text-align: center;
  -webkit-border-radius: 20px;
  -moz-border-radius: 20px;
  border-radius: 20px;
  -webkit-box-shadow: 0 0 3px rgba(0,0,0,.2);
  -moz-box-shadow: 0 0 3px rgba(0,0,0,.2);
  box-shadow: 0 0 3px rgba(0,0,0,.2);
  color: inherit;
}

#menu li a {
  display: block;
  color: white;
  padding: 0 35px 0 25px;
  -webkit-transition: background 300ms;
  -moz-transition: background 300ms;
}

#menu li {
  position: relative;
  list-style: none;
}

#menu a:hover,
#menu a.active {
  text-decoration: none;
  background: rgba(255,255,255,.1);
}

#menu li:hover .cov {
  opacity: 1;
}

#menu li .dirname {
  opacity: .60;
  padding-right: 2px;
}

#menu li .basename {
  opacity: 1;
}

#menu .cov {
  background: rgba(0,0,0,.4);
  position: absolute;
  top: 0;
  right: 8px;
  font-size: 9px;
  opacity: .6;
  text-align: left;
  width: 17px;
  -webkit-border-radius: 10px;
  -moz-border-radius: 10px;
  border-radius: 10px;
  padding: 2px 3px;
  text-align: center;
}

#stats:nth-child(2n) {
  display: inline-block;
  margin-top: 15px;
  border: 1px solid #eee;
  padding: 10px;
  -webkit-box-shadow: inset 0 0 2px #eee;
  -moz-box-shadow: inset 0 0 2px #eee;
  box-shadow: inset 0 0 2px #eee;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  border-radius: 5px;
}

#stats div {
  float: left;
  padding: 0 5px;
}

#stats::after {
  display: block;
  content: '';
  clear: both;
}

#stats .sloc::after {
  content: ' SLOC';
  color: #b6b6b6;
}

#stats .percentage::after {
  content: ' coverage';
  color: #b6b6b6;
}

#stats .hits,
#stats .misses {
  display: none;
}

.high {
  color: #00d4b4;
}
.medium {
  color: #e87d0d;
}
.low {
  color: #d4081a;
}
.terrible {
  color: #d4081a;
  font-weight: bold;
}

table {
  width: 80%;
  margin-top: 10px;
  border-collapse: collapse;
  border: 1px solid #cbcbcb;
  color: #363636;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
}

table thead {
  display: none;
}

table td.line,
table td.hits {
  width: 20px;
  background: #eaeaea;
  text-align: center;
  font-size: 11px;
  padding: 0 10px;
  color: #949494;
}

table td.hits {
  width: 10px;
  padding: 2px 5px;
  color: rgba(0,0,0,.2);
  background: #f0f0f0;
}

tr.miss td.line,
tr.miss td.hits {
  background: #e6c3c7;
}

tr.miss td {
  background: #f8d5d8;
}

td.source {
  padding-left: 15px;
  line-height: 15px;
  white-space: pre;
  font: 12px monaco, monospace;
}

code .comment { color: #ddd }
code .init { color: #2F6FAD }
code .string { color: #5890AD }
code .keyword { color: #8A6343 }
code .number { color: #2F6FAD }
</style></head><body><div id="coverage"><h1 id="overview">Coverage</h1><div id="menu"><li><a href="#overview">overview</a></li><li><span class="cov high">100</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/config.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/</span><span class="basename">config.coffee</span></a></li><li><span class="cov high">90</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/controllers/auth.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/controllers/</span><span class="basename">auth.coffee</span></a></li><li><span class="cov high">100</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/controllers/connect.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/controllers/</span><span class="basename">connect.coffee</span></a></li><li><span class="cov high">100</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/controllers/query.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/controllers/</span><span class="basename">query.coffee</span></a></li><li><span class="cov high">77</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/controllers/socket.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/controllers/</span><span class="basename">socket.coffee</span></a></li><li><span class="cov high">95</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/controllers/storage.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/controllers/</span><span class="basename">storage.coffee</span></a></li><li><span class="cov medium">53</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/controllers/sync.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/controllers/</span><span class="basename">sync.coffee</span></a></li><li><span class="cov high">98</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/controllers/table.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/controllers/</span><span class="basename">table.coffee</span></a></li><li><span class="cov high">95</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/controllers/validation.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/controllers/</span><span class="basename">validation.coffee</span></a></li><li><span class="cov high">83</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/database/list.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/database/</span><span class="basename">list.coffee</span></a></li><li><span class="cov high">87</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/database/list_tasks.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/database/</span><span class="basename">list_tasks.coffee</span></a></li><li><span class="cov high">86</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/database/login.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/database/</span><span class="basename">login.coffee</span></a></li><li><span class="cov high">77</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/database/pref.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/database/</span><span class="basename">pref.coffee</span></a></li><li><span class="cov high">80</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/database/register.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/database/</span><span class="basename">register.coffee</span></a></li><li><span class="cov high">87</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/database/reset.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/database/</span><span class="basename">reset.coffee</span></a></li><li><span class="cov medium">65</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/database/task.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/database/</span><span class="basename">task.coffee</span></a></li><li><span class="cov high">76</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/database/user.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/database/</span><span class="basename">user.coffee</span></a></li><li><span class="cov high">99</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/models/user.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/models/</span><span class="basename">user.coffee</span></a></li><li><span class="cov high">75</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/utils/keychain.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/utils/</span><span class="basename">keychain.coffee</span></a></li><li><span class="cov high">92</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/utils/log.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/utils/</span><span class="basename">log.coffee</span></a></li><li><span class="cov low">36</span><a href="#/Volumes/Home/Projects/Nitro-Sync/app/utils/time.coffee"><span class="dirname">/Volumes/Home/Projects/Nitro-Sync/app/utils/</span><span class="basename">time.coffee</span></a></li><a id="logo" href="http://visionmedia.github.io/mocha/">m</a></div><div id="stats" class="high"><div class="percentage">79%</div><div class="sloc">1095</div><div class="hits">868</div><div class="misses">227</div></div><div id="files"><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/config.coffee">/Volumes/Home/Projects/Nitro-Sync/app/config.coffee</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">12</div><div class="hits">12</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var config, keychain;</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">  keychain = require('./utils/keychain');</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  config = {</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">    use: function(platform) {</td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">      var key, value, _ref, _results;</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">      _ref = config[platform];</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">      _results = [];</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">      for (key in _ref) {</td></tr><tr class="hit"><td class="line">12</td><td class="hits">3</td><td class="source">        value = _ref[key];</td></tr><tr class="hit"><td class="line">13</td><td class="hits">3</td><td class="source">        _results.push(config[key] = value);</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">      return _results;</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    production: {</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">      url: 'http://sync.nitrotasks.com',</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">      port: process.env.PORT || 8080,</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">      database: {</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        engine: keychain('sql_type'),</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        host: keychain('sql_host'),</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        port: keychain('sql_port'),</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        user: keychain('sql_user'),</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        password: keychain('sql_pass'),</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        database: keychain('sql_db')</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    development: {</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">      url: 'http://localhost:8080',</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">      port: process.env.PORT || 8080,</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">      database: {</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        engine: 'mysql',</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        host: '127.0.0.1',</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        port: 3306,</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        user: 'nodejs',</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        password: 'nodejs',</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        database: 'Nitro'</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    testing: {</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">      url: 'http://localhost:8080',</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">      port: 8080,</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">      database: {</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        engine: 'mysql',</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        host: '127.0.0.1',</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        port: 3306,</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">        user: 'nodejs',</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        password: 'nodejs',</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">        database: 'Nitro_Test',</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        charset: 'utf8'</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">56</td><td class="hits">1</td><td class="source">  module.exports = config;</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/controllers/auth.coffee">/Volumes/Home/Projects/Nitro-Sync/app/controllers/auth.coffee</h2><div id="stats" class="high"><div class="percentage">90%</div><div class="sloc">54</div><div class="hits">49</div><div class="misses">5</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var Auth, ERR_BAD_EMAIL, ERR_BAD_NAME, ERR_BAD_PASS, Keys, LOGIN_TOKEN_LENGTH, Q, REGISTRATION_TOKEN_LENGTH, RESET_TOKEN_LENGTH, Storage, bcrypt, crypto;</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">  Q = require('kew');</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  bcrypt = require('bcrypt');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">  crypto = require('crypto');</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">  Storage = require('../controllers/storage');</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">  Keys = require('../utils/keychain');</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">  bcrypt = {</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    compare: Q.bindPromise(bcrypt.compare, bcrypt),</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    hash: Q.bindPromise(bcrypt.hash, bcrypt),</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    salt: Q.bindPromise(bcrypt.genSalt, bcrypt)</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">  RESET_TOKEN_LENGTH = 22;</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">  LOGIN_TOKEN_LENGTH = 64;</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">  REGISTRATION_TOKEN_LENGTH = 22;</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">  ERR_BAD_PASS = 'err_bad_pass';</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">  ERR_BAD_EMAIL = 'err_bad_email';</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">  ERR_BAD_NAME = 'err_bad_name';</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">32</td><td class="hits">1</td><td class="source">  Auth = {</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">     * Hash some data using bcrypt</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">     * The salt is randomly generated.</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">     * - data (string)</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">     * &gt; encrypted data</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    hash: function(data) {</td></tr><tr class="hit"><td class="line">42</td><td class="hits">6</td><td class="source">      return bcrypt.salt(10).then(function(salt) {</td></tr><tr class="hit"><td class="line">43</td><td class="hits">6</td><td class="source">        return bcrypt.hash(data, salt);</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">     * Check a hash against some data</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">     * - data (string)</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">     * - hash (buffer?)</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">    compare: function(data, hash) {</td></tr><tr class="hit"><td class="line">54</td><td class="hits">6</td><td class="source">      return bcrypt.compare(data, hash);</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">     * Wrap crypto.randomBytes in a promise</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">     * - len (int) : number of bytes to get</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">     * &gt; buffer</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">    randomBytes: Q.bindPromise(crypto.randomBytes, crypto),</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">     * Generate a random string of a certain length.</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">     * We generate a bunch of random bytes and then covert them to base64.</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">     * We make sure to generate more bytes then we need and then cut</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">     * the excess off. This way we don't get any of the base64 padding.</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">     * - len (int) : The length of the string</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">    createToken: function(len) {</td></tr><tr class="hit"><td class="line">74</td><td class="hits">14</td><td class="source">      var byteLen;</td></tr><tr class="hit"><td class="line">75</td><td class="hits">14</td><td class="source">      byteLen = Math.ceil(len / 2);</td></tr><tr class="hit"><td class="line">76</td><td class="hits">14</td><td class="source">      return Auth.randomBytes(byteLen).then(function(bytes) {</td></tr><tr class="hit"><td class="line">77</td><td class="hits">14</td><td class="source">        return bytes.toString('hex').slice(0, len);</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">     * Generate a password reset token for a user</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">     * - email (string) : the email of the user</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">     * &gt; token</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">    createResetToken: function(email) {</td></tr><tr class="hit"><td class="line">88</td><td class="hits">2</td><td class="source">      return Q.all([Auth.createToken(RESET_TOKEN_LENGTH), Storage.getByEmail(email)]).then(function(_arg) {</td></tr><tr class="hit"><td class="line">89</td><td class="hits">1</td><td class="source">        var token, user;</td></tr><tr class="hit"><td class="line">90</td><td class="hits">1</td><td class="source">        token = _arg[0], user = _arg[1];</td></tr><tr class="hit"><td class="line">91</td><td class="hits">1</td><td class="source">        return Storage.addResetToken(user.id, token);</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">     * Create a login token for a user</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">     * - id (int) : The user id</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">     * &gt; token</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">    createLoginToken: function(id) {</td></tr><tr class="hit"><td class="line">102</td><td class="hits">3</td><td class="source">      return Auth.createToken(LOGIN_TOKEN_LENGTH).then(function(token) {</td></tr><tr class="hit"><td class="line">103</td><td class="hits">3</td><td class="source">        return Storage.addLoginToken(id, token);</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">     * Generate a login token for a user</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">     * Only works if the email and password match</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">     * - email (string)</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">     * - pass (string) : plaintext</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">     * &gt; user and token info</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">     * ! err_bad_pass</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">    login: function(email, pass) {</td></tr><tr class="hit"><td class="line">117</td><td class="hits">4</td><td class="source">      var user;</td></tr><tr class="hit"><td class="line">118</td><td class="hits">4</td><td class="source">      user = null;</td></tr><tr class="hit"><td class="line">119</td><td class="hits">4</td><td class="source">      return Storage.getByEmail(email).then(function(_user) {</td></tr><tr class="hit"><td class="line">120</td><td class="hits">4</td><td class="source">        user = _user;</td></tr><tr class="hit"><td class="line">121</td><td class="hits">4</td><td class="source">        return user.getPassword('password');</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">      }).then(function(password) {</td></tr><tr class="hit"><td class="line">123</td><td class="hits">4</td><td class="source">        return Auth.compare(pass, password);</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">      }).then(function(same) {</td></tr><tr class="hit"><td class="line">125</td><td class="hits">4</td><td class="source">        if (!same) {</td></tr><tr class="hit"><td class="line">126</td><td class="hits">1</td><td class="source">          throw ERR_BAD_PASS;</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">128</td><td class="hits">3</td><td class="source">        return Auth.createLoginToken(user.id);</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">      }).then(function(token) {</td></tr><tr class="hit"><td class="line">130</td><td class="hits">3</td><td class="source">        return [user.id, token];</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">      }).fail(function() {</td></tr><tr class="hit"><td class="line">132</td><td class="hits">1</td><td class="source">        throw ERR_BAD_PASS;</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">     * Register a user.</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">     * Hashes the users password and stores it in the database</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">     * - name (string)</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">     * - email (string)</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">     * - pass (string) : plaintext</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">     * &gt; registration token</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">     * ! err_bad_name</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">     * ! err_bad_email</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">     * ! err_bad_pass</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">    register: function(name, email, pass) {</td></tr><tr class="hit"><td class="line">149</td><td class="hits">4</td><td class="source">      if (name.length === 0) {</td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="source">        return Q.reject(ERR_BAD_NAME);</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">152</td><td class="hits">4</td><td class="source">      if (email.length === 0) {</td></tr><tr class="miss"><td class="line">153</td><td class="hits">0</td><td class="source">        return Q.reject(ERR_BAD_EMAIL);</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">155</td><td class="hits">4</td><td class="source">      if (pass.length === 0) {</td></tr><tr class="miss"><td class="line">156</td><td class="hits">0</td><td class="source">        return Q.reject(ERR_BAD_PASS);</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">158</td><td class="hits">4</td><td class="source">      return Q.all([Auth.createToken(REGISTRATION_TOKEN_LENGTH), Auth.hash(pass)]).then(function(_arg) {</td></tr><tr class="hit"><td class="line">159</td><td class="hits">4</td><td class="source">        var hash, token;</td></tr><tr class="hit"><td class="line">160</td><td class="hits">4</td><td class="source">        token = _arg[0], hash = _arg[1];</td></tr><tr class="hit"><td class="line">161</td><td class="hits">4</td><td class="source">        return Storage.register(token, name, email, hash);</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">     * Verify a registration using a token.</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">     * Should be used to verify that the user owns the email address.</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">     * - token (string) : the registration token</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">     * &gt; user info stored at registration</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">    verifyRegistration: function(token) {</td></tr><tr class="hit"><td class="line">173</td><td class="hits">4</td><td class="source">      return Storage.getRegistration(token).then(function(user) {</td></tr><tr class="hit"><td class="line">174</td><td class="hits">4</td><td class="source">        return Storage.add({</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">          name: user.name,</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">          email: user.email,</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">          password: user.password</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">     * Change a users password</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">     * - user (user) : the user instance</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">     * - pass (string) : plaintext</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">    changePassword: function(user, pass) {</td></tr><tr class="miss"><td class="line">189</td><td class="hits">0</td><td class="source">      return Auth.hash(pass).then(function(hash) {</td></tr><tr class="miss"><td class="line">190</td><td class="hits">0</td><td class="source">        return user.setPassword(hash);</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">195</td><td class="hits">1</td><td class="source">  module.exports = Auth;</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/controllers/connect.coffee">/Volumes/Home/Projects/Nitro-Sync/app/controllers/connect.coffee</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">11</div><div class="hits">11</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var Knex, Q, config, connect, url;</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">  Q = require('kew');</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  url = require('url');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">  Knex = require('knex');</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">  config = require('../config');</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">  connect = {</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    ready: Q.defer(),</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">     * - type (string) : 'production', 'development', 'testing'</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    init: function() {</td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">      console.log('intializing');</td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">      this.db = Knex.initialize({</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        client: config.database.engine,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        connection: config.database</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">      });</td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">      return this.ready.resolve();</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">  module.exports = connect;</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/controllers/query.coffee">/Volumes/Home/Projects/Nitro-Sync/app/controllers/query.coffee</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">21</div><div class="hits">21</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var Log, Q, connect, connected, initiateTables, log, tables, warn;</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">  Q = require('kew');</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  connect = require('../controllers/connect');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">  Log = require('../utils/log');</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">  log = Log('Database', 'blue');</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">  warn = Log('Database', 'red');</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">  tables = {</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    user: require('../database/user'),</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    list: require('../database/list'),</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    task: require('../database/task'),</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    pref: require('../database/pref'),</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    login: require('../database/login'),</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    reset: require('../database/reset'),</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    register: require('../database/register'),</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    listTasks: require('../database/list_tasks')</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">  initiateTables = function(queryFn) {</td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">    var Table, name, promises, table;</td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">    promises = [];</td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">    for (name in tables) {</td></tr><tr class="hit"><td class="line">29</td><td class="hits">8</td><td class="source">      Table = tables[name];</td></tr><tr class="hit"><td class="line">30</td><td class="hits">8</td><td class="source">      table = new Table(queryFn);</td></tr><tr class="hit"><td class="line">31</td><td class="hits">8</td><td class="source">      promises.push(table.setup());</td></tr><tr class="hit"><td class="line">32</td><td class="hits">8</td><td class="source">      module.exports[name] = table;</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">    return Q.all(promises);</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">37</td><td class="hits">1</td><td class="source">  connected = connect.ready.then(function() {</td></tr><tr class="hit"><td class="line">38</td><td class="hits">1</td><td class="source">    module.exports.query = connect.db;</td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">    return initiateTables(connect.db);</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">42</td><td class="hits">1</td><td class="source">  module.exports = {</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">    connected: connected</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/controllers/socket.coffee">/Volumes/Home/Projects/Nitro-Sync/app/controllers/socket.coffee</h2><div id="stats" class="high"><div class="percentage">77%</div><div class="sloc">235</div><div class="hits">181</div><div class="misses">54</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var CLASSES, CREATE, DESTROY, GuestSocket, INBOX, Jandal, LIST, Log, PREF, SERVER_PREFIX, SOCKET_URL, Socket, Storage, Sync, TASK, TIMEOUT_AUTH, UPDATE, UserSocket, Validation, init, log, sockjs, xType,</td></tr><tr class="hit"><td class="line">3</td><td class="hits">1102</td><td class="source">    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">    __hasProp = {}.hasOwnProperty,</td></tr><tr class="hit"><td class="line">5</td><td class="hits">14</td><td class="source">    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">  sockjs = require('sockjs');</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">  Jandal = require('jandal');</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">  xType = require('xtype');</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">  Sync = require('../controllers/sync');</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">  Storage = require('../controllers/storage');</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">  Validation = require('../controllers/validation');</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">  Log = require('../utils/log');</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">  log = Log('Socket', 'yellow');</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">  Jandal.handle('node');</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">  SERVER_PREFIX = 's';</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">  SOCKET_URL = '/socket';</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">29</td><td class="hits">1</td><td class="source">  CREATE = 0;</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">  UPDATE = 1;</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">33</td><td class="hits">1</td><td class="source">  DESTROY = 2;</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">  TASK = 'task';</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">37</td><td class="hits">1</td><td class="source">  LIST = 'list';</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">  PREF = 'pref';</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">41</td><td class="hits">1</td><td class="source">  INBOX = 'inbox';</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">43</td><td class="hits">1</td><td class="source">  TIMEOUT_AUTH = 3000;</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">45</td><td class="hits">1</td><td class="source">  CLASSES = [TASK, LIST, PREF];</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">  /*</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">   * Init</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">   * Start the SockJS server and attach it to the HTTP server</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">   *</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">   * - server (Server) - web server to attach to</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">   * - [sjs] (SockJS) - used for testing so we can inject our own mock server</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">  */</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">57</td><td class="hits">1</td><td class="source">  init = function(server, sjs) {</td></tr><tr class="hit"><td class="line">58</td><td class="hits">18</td><td class="source">    var websockets;</td></tr><tr class="hit"><td class="line">59</td><td class="hits">18</td><td class="source">    if (sjs == null) {</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">      sjs = sockjs;</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">62</td><td class="hits">18</td><td class="source">    websockets = sjs.createServer();</td></tr><tr class="hit"><td class="line">63</td><td class="hits">18</td><td class="source">    websockets.installHandlers(server, {</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">      prefix: SOCKET_URL</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">66</td><td class="hits">18</td><td class="source">    return websockets.on('connection', function(socket) {</td></tr><tr class="hit"><td class="line">67</td><td class="hits">26</td><td class="source">      return new GuestSocket(socket);</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">71</td><td class="hits">1</td><td class="source">  Socket = (function() {</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">     * Socket</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">     * - _socket (Socket) : a WebSocket connection</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">78</td><td class="hits">1</td><td class="source">    function Socket(_socket) {</td></tr><tr class="hit"><td class="line">79</td><td class="hits">49</td><td class="source">      this._socket = _socket;</td></tr><tr class="hit"><td class="line">80</td><td class="hits">49</td><td class="source">      this.close = __bind(this.close, this);</td></tr><tr class="hit"><td class="line">81</td><td class="hits">49</td><td class="source">      this.end = __bind(this.end, this);</td></tr><tr class="hit"><td class="line">82</td><td class="hits">49</td><td class="source">      this.release = __bind(this.release, this);</td></tr><tr class="hit"><td class="line">83</td><td class="hits">49</td><td class="source">      this.bindEvents = __bind(this.bindEvents, this);</td></tr><tr class="hit"><td class="line">84</td><td class="hits">49</td><td class="source">      this.socket = new Jandal(this._socket);</td></tr><tr class="hit"><td class="line">85</td><td class="hits">49</td><td class="source">      this.bindEvents();</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">     * (Private) Bind Events</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">     * Loop thorough each event in @events and bind them to the socket.</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">     * @events should be an object in the format { &lt;namespace&gt;: [ &lt;event&gt; ] }</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">     * The function handler should be named &lt;namespace&gt;_&lt;event&gt;</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">     * - [action] (string)</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">99</td><td class="hits">1</td><td class="source">    Socket.prototype.bindEvents = function(action) {</td></tr><tr class="hit"><td class="line">100</td><td class="hits">72</td><td class="source">      var event, fn, id, methods, name, ns, _ref, _results;</td></tr><tr class="hit"><td class="line">101</td><td class="hits">72</td><td class="source">      if (action == null) {</td></tr><tr class="hit"><td class="line">102</td><td class="hits">49</td><td class="source">        action = 'on';</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">104</td><td class="hits">72</td><td class="source">      if (!this.events) {</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">        return;</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">107</td><td class="hits">72</td><td class="source">      _ref = this.events;</td></tr><tr class="hit"><td class="line">108</td><td class="hits">72</td><td class="source">      _results = [];</td></tr><tr class="hit"><td class="line">109</td><td class="hits">72</td><td class="source">      for (name in _ref) {</td></tr><tr class="hit"><td class="line">110</td><td class="hits">164</td><td class="source">        methods = _ref[name];</td></tr><tr class="hit"><td class="line">111</td><td class="hits">164</td><td class="source">        ns = this.socket.namespace(name);</td></tr><tr class="hit"><td class="line">112</td><td class="hits">164</td><td class="source">        _results.push((function() {</td></tr><tr class="hit"><td class="line">113</td><td class="hits">164</td><td class="source">          var _i, _len, _results1;</td></tr><tr class="hit"><td class="line">114</td><td class="hits">164</td><td class="source">          _results1 = [];</td></tr><tr class="hit"><td class="line">115</td><td class="hits">164</td><td class="source">          for (_i = 0, _len = methods.length; _i &lt; _len; _i++) {</td></tr><tr class="hit"><td class="line">116</td><td class="hits">325</td><td class="source">            event = methods[_i];</td></tr><tr class="hit"><td class="line">117</td><td class="hits">325</td><td class="source">            id = name + '_' + event;</td></tr><tr class="hit"><td class="line">118</td><td class="hits">325</td><td class="source">            fn = xType.guard(id, this[id], this);</td></tr><tr class="hit"><td class="line">119</td><td class="hits">325</td><td class="source">            _results1.push(ns[action](event, fn));</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">          }</td></tr><tr class="hit"><td class="line">121</td><td class="hits">164</td><td class="source">          return _results1;</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">        }).call(this));</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">124</td><td class="hits">72</td><td class="source">      return _results;</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">     * Release</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">     * Release control over the web socket.</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">     * This just unbinds all the events.</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">135</td><td class="hits">1</td><td class="source">    Socket.prototype.release = function() {</td></tr><tr class="hit"><td class="line">136</td><td class="hits">23</td><td class="source">      return this.bindEvents('removeListener');</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">     * End</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">     * Disconnect the socket from the server using the default status code and</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">     * error message.</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">147</td><td class="hits">1</td><td class="source">    Socket.prototype.end = function() {</td></tr><tr class="miss"><td class="line">148</td><td class="hits">0</td><td class="source">      return this._socket.end();</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">     * Close</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">     * Close the socket connection and also send a status code and error message.</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">     * Status codes: http://tools.ietf.org/html/rfc6455#section-7.4.1</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">     * - status (int)</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">     * - message (string)</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">162</td><td class="hits">1</td><td class="source">    Socket.prototype.close = function(status, message) {</td></tr><tr class="hit"><td class="line">163</td><td class="hits">3</td><td class="source">      return this._socket.close(status, message);</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">166</td><td class="hits">1</td><td class="source">    return Socket;</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">  })();</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">170</td><td class="hits">1</td><td class="source">  GuestSocket = (function(_super) {</td></tr><tr class="hit"><td class="line">171</td><td class="hits">1</td><td class="source">    __extends(GuestSocket, _super);</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">173</td><td class="hits">1</td><td class="source">    GuestSocket.prototype.events = {</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">      user: ['auth']</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">     * GuestSocket</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">     * This will handle a newly created socket and allow them to authenticate</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">     * themselves. There is a limited time to authenticate before the socket</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">     * will be automatically closed. This is done so that the server doesn't</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">     * have to handle any more sockets than it needs to.</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">     * - socket (Jandal)</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">189</td><td class="hits">1</td><td class="source">    function GuestSocket(socket) {</td></tr><tr class="hit"><td class="line">190</td><td class="hits">26</td><td class="source">      this.timeout = __bind(this.timeout, this);</td></tr><tr class="hit"><td class="line">191</td><td class="hits">26</td><td class="source">      this.kick = __bind(this.kick, this);</td></tr><tr class="hit"><td class="line">192</td><td class="hits">26</td><td class="source">      this.login = __bind(this.login, this);</td></tr><tr class="hit"><td class="line">193</td><td class="hits">26</td><td class="source">      this.user_auth = __bind(this.user_auth, this);</td></tr><tr class="hit"><td class="line">194</td><td class="hits">26</td><td class="source">      GuestSocket.__super__.constructor.apply(this, arguments);</td></tr><tr class="hit"><td class="line">195</td><td class="hits">26</td><td class="source">      log('A new guest has connected');</td></tr><tr class="hit"><td class="line">196</td><td class="hits">26</td><td class="source">      this.authenticated = false;</td></tr><tr class="hit"><td class="line">197</td><td class="hits">26</td><td class="source">      this.authTimeout = setTimeout(this.timeout, TIMEOUT_AUTH);</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">     * User Authentication</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">     * The callback function will only be called if authentication is successful,</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">     * otherwise the socket will be instantly closed and an error message will be</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">     * sent back with it.</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">     * - userId (int) : id of the user</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">     * - token (string) : login token</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">     * - fn (function) : callback</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">213</td><td class="hits">1</td><td class="source">    GuestSocket.prototype.user_auth = function(userId, token, fn) {</td></tr><tr class="hit"><td class="line">214</td><td class="hits">24</td><td class="source">      var _this = this;</td></tr><tr class="hit"><td class="line">215</td><td class="hits">24</td><td class="source">      this.userId = userId;</td></tr><tr class="hit"><td class="line">216</td><td class="hits">24</td><td class="source">      clearTimeout(this.authTimeout);</td></tr><tr class="hit"><td class="line">217</td><td class="hits">24</td><td class="source">      return Storage.checkLoginToken(this.userId, token).then(function(exists) {</td></tr><tr class="hit"><td class="line">218</td><td class="hits">24</td><td class="source">        if (exists) {</td></tr><tr class="hit"><td class="line">219</td><td class="hits">23</td><td class="source">          return _this.login(fn);</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">221</td><td class="hits">1</td><td class="source">          return _this.kick();</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">      }).fail(function(err) {</td></tr><tr class="miss"><td class="line">224</td><td class="hits">0</td><td class="source">        log(err);</td></tr><tr class="miss"><td class="line">225</td><td class="hits">0</td><td class="source">        return _this.kick(err);</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">     * (Private) User Login</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">     * This handles logging in a user after they have been authenticated.</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">     * It releases control of the Jandal instance and then creates a new</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source">     * UserSocket. If an error occurs, the socket will be closed.</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">     * - fn (callback)</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">240</td><td class="hits">1</td><td class="source">    GuestSocket.prototype.login = function(fn) {</td></tr><tr class="hit"><td class="line">241</td><td class="hits">23</td><td class="source">      var socket,</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">        _this = this;</td></tr><tr class="hit"><td class="line">243</td><td class="hits">23</td><td class="source">      socket = this._socket;</td></tr><tr class="hit"><td class="line">244</td><td class="hits">23</td><td class="source">      this.release();</td></tr><tr class="hit"><td class="line">245</td><td class="hits">23</td><td class="source">      return Storage.get(this.userId).then(function(user) {</td></tr><tr class="hit"><td class="line">246</td><td class="hits">23</td><td class="source">        new UserSocket(socket, user);</td></tr><tr class="hit"><td class="line">247</td><td class="hits">23</td><td class="source">        return fn(null, true);</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">      }).fail(function(err) {</td></tr><tr class="miss"><td class="line">249</td><td class="hits">0</td><td class="source">        log(err);</td></tr><tr class="miss"><td class="line">250</td><td class="hits">0</td><td class="source">        return _this.kick(err);</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">     * (Private) Kick</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">     * This will close a socket because authentication has failed.</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">     * [message] (string) : Optional error message</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">263</td><td class="hits">1</td><td class="source">    GuestSocket.prototype.kick = function(message) {</td></tr><tr class="hit"><td class="line">264</td><td class="hits">1</td><td class="source">      if (message == null) {</td></tr><tr class="hit"><td class="line">265</td><td class="hits">1</td><td class="source">        message = 'err_bad_token';</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">267</td><td class="hits">1</td><td class="source">      return this.close(3002, message);</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source">     * (Private) Timeout</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source">     * This will close a socket because no attempt was made to authenticate</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source">     * within the time limit.</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">278</td><td class="hits">1</td><td class="source">    GuestSocket.prototype.timeout = function() {</td></tr><tr class="hit"><td class="line">279</td><td class="hits">2</td><td class="source">      return this.close(1002, 'err_auth_timeout');</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">282</td><td class="hits">1</td><td class="source">    return GuestSocket;</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">  })(Socket);</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">286</td><td class="hits">1</td><td class="source">  UserSocket = (function(_super) {</td></tr><tr class="hit"><td class="line">287</td><td class="hits">1</td><td class="source">    __extends(UserSocket, _super);</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">289</td><td class="hits">1</td><td class="source">    UserSocket.prototype.events = {</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">      queue: ['sync'],</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">      user: ['info'],</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source">      list: ['create', 'update', 'destroy', 'fetch'],</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">      task: ['create', 'update', 'destroy', 'fetch'],</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source">      pref: ['update', 'fetch']</td></tr><tr><td class="line">295</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">296</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">297</td><td class="hits">1</td><td class="source">    function UserSocket(socket, user) {</td></tr><tr class="hit"><td class="line">298</td><td class="hits">23</td><td class="source">      this.user = user;</td></tr><tr class="hit"><td class="line">299</td><td class="hits">23</td><td class="source">      this.queue_sync = __bind(this.queue_sync, this);</td></tr><tr class="hit"><td class="line">300</td><td class="hits">23</td><td class="source">      this.list_destroy = __bind(this.list_destroy, this);</td></tr><tr class="hit"><td class="line">301</td><td class="hits">23</td><td class="source">      this.task_destroy = __bind(this.task_destroy, this);</td></tr><tr class="hit"><td class="line">302</td><td class="hits">23</td><td class="source">      this.destroy = __bind(this.destroy, this);</td></tr><tr class="hit"><td class="line">303</td><td class="hits">23</td><td class="source">      this.pref_update = __bind(this.pref_update, this);</td></tr><tr class="hit"><td class="line">304</td><td class="hits">23</td><td class="source">      this.list_update = __bind(this.list_update, this);</td></tr><tr class="hit"><td class="line">305</td><td class="hits">23</td><td class="source">      this.task_update = __bind(this.task_update, this);</td></tr><tr class="hit"><td class="line">306</td><td class="hits">23</td><td class="source">      this.update = __bind(this.update, this);</td></tr><tr class="hit"><td class="line">307</td><td class="hits">23</td><td class="source">      this.list_create = __bind(this.list_create, this);</td></tr><tr class="hit"><td class="line">308</td><td class="hits">23</td><td class="source">      this.task_create = __bind(this.task_create, this);</td></tr><tr class="hit"><td class="line">309</td><td class="hits">23</td><td class="source">      this.create = __bind(this.create, this);</td></tr><tr class="hit"><td class="line">310</td><td class="hits">23</td><td class="source">      this.pref_fetch = __bind(this.pref_fetch, this);</td></tr><tr class="hit"><td class="line">311</td><td class="hits">23</td><td class="source">      this.list_fetch = __bind(this.list_fetch, this);</td></tr><tr class="hit"><td class="line">312</td><td class="hits">23</td><td class="source">      this.task_fetch = __bind(this.task_fetch, this);</td></tr><tr class="hit"><td class="line">313</td><td class="hits">23</td><td class="source">      this.user_info = __bind(this.user_info, this);</td></tr><tr class="hit"><td class="line">314</td><td class="hits">23</td><td class="source">      this.broadcast = __bind(this.broadcast, this);</td></tr><tr class="hit"><td class="line">315</td><td class="hits">23</td><td class="source">      UserSocket.__super__.constructor.apply(this, arguments);</td></tr><tr class="hit"><td class="line">316</td><td class="hits">23</td><td class="source">      log('A user has been authenticated');</td></tr><tr class="hit"><td class="line">317</td><td class="hits">23</td><td class="source">      this.authenticated = true;</td></tr><tr class="hit"><td class="line">318</td><td class="hits">23</td><td class="source">      this.socket.join(this.user.id);</td></tr><tr class="hit"><td class="line">319</td><td class="hits">23</td><td class="source">      this.sync = new Sync(this.user);</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">322</td><td class="hits">1</td><td class="source">    UserSocket.prototype.broadcast = function(event, arg1, arg2, arg3) {</td></tr><tr class="hit"><td class="line">323</td><td class="hits">59</td><td class="source">      return this.socket.broadcast.to(this.user.id).emit(event, arg1, arg2, arg3);</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">326</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">327</td><td class="hits"></td><td class="source">     * User Info</td></tr><tr><td class="line">328</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">329</td><td class="hits"></td><td class="source">     * - fn (function)</td></tr><tr><td class="line">330</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">331</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">332</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">333</td><td class="hits">1</td><td class="source">    UserSocket.prototype.user_info = function(fn) {</td></tr><tr class="hit"><td class="line">334</td><td class="hits">1</td><td class="source">      return this.user.info().then(function(info) {</td></tr><tr class="hit"><td class="line">335</td><td class="hits">1</td><td class="source">        return fn(null, info);</td></tr><tr><td class="line">336</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">337</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">338</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">339</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source">     * Model Fetch</td></tr><tr><td class="line">341</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">342</td><td class="hits"></td><td class="source">     * - classname (string)</td></tr><tr><td class="line">343</td><td class="hits"></td><td class="source">     * - fn (function)</td></tr><tr><td class="line">344</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">345</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">347</td><td class="hits">1</td><td class="source">    UserSocket.prototype.task_fetch = function(fn) {</td></tr><tr class="hit"><td class="line">348</td><td class="hits">2</td><td class="source">      return this.user.exportTasks().then(function(info) {</td></tr><tr class="hit"><td class="line">349</td><td class="hits">2</td><td class="source">        return fn(null, info);</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">351</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">353</td><td class="hits">1</td><td class="source">    UserSocket.prototype.list_fetch = function(fn) {</td></tr><tr class="miss"><td class="line">354</td><td class="hits">0</td><td class="source">      return this.user.exportLists().then(function(info) {</td></tr><tr class="miss"><td class="line">355</td><td class="hits">0</td><td class="source">        return fn(null, info);</td></tr><tr><td class="line">356</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">357</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">358</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">359</td><td class="hits">1</td><td class="source">    UserSocket.prototype.pref_fetch = function(fn) {</td></tr><tr class="miss"><td class="line">360</td><td class="hits">0</td><td class="source">      return this.user.exportPref().then(function(info) {</td></tr><tr class="miss"><td class="line">361</td><td class="hits">0</td><td class="source">        return fn(null, info);</td></tr><tr><td class="line">362</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">363</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">364</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source">     * Model Create</td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">368</td><td class="hits"></td><td class="source">     * - model (object)</td></tr><tr><td class="line">369</td><td class="hits"></td><td class="source">     * - fn (function)</td></tr><tr><td class="line">370</td><td class="hits"></td><td class="source">     * - [time] (number)</td></tr><tr><td class="line">371</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">372</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">373</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">374</td><td class="hits">1</td><td class="source">    UserSocket.prototype.create = function(classname, model, fn, time) {</td></tr><tr class="hit"><td class="line">375</td><td class="hits">21</td><td class="source">      var _this = this;</td></tr><tr class="hit"><td class="line">376</td><td class="hits">21</td><td class="source">      return this.sync[classname + '_create'](model, time).then(function(id) {</td></tr><tr class="hit"><td class="line">377</td><td class="hits">17</td><td class="source">        _this.broadcast(classname + '.create', model);</td></tr><tr class="hit"><td class="line">378</td><td class="hits">17</td><td class="source">        if (fn) {</td></tr><tr class="hit"><td class="line">379</td><td class="hits">17</td><td class="source">          fn(null, id);</td></tr><tr><td class="line">380</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">381</td><td class="hits">17</td><td class="source">        return id;</td></tr><tr><td class="line">382</td><td class="hits"></td><td class="source">      }).fail(function() {</td></tr><tr class="hit"><td class="line">383</td><td class="hits">4</td><td class="source">        if (fn) {</td></tr><tr class="hit"><td class="line">384</td><td class="hits">4</td><td class="source">          return fn(true);</td></tr><tr><td class="line">385</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">386</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">387</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">388</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">389</td><td class="hits">1</td><td class="source">    UserSocket.prototype.task_create = function(model, fn, time) {</td></tr><tr class="hit"><td class="line">390</td><td class="hits">6</td><td class="source">      return this.create(TASK, model, fn, time);</td></tr><tr><td class="line">391</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">392</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">393</td><td class="hits">1</td><td class="source">    UserSocket.prototype.list_create = function(model, fn, time) {</td></tr><tr class="hit"><td class="line">394</td><td class="hits">15</td><td class="source">      return this.create(LIST, model, fn, time);</td></tr><tr><td class="line">395</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">396</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">397</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">398</td><td class="hits"></td><td class="source">     * Model Update</td></tr><tr><td class="line">399</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">400</td><td class="hits"></td><td class="source">     * - model (object)</td></tr><tr><td class="line">401</td><td class="hits"></td><td class="source">     * - [fn] (function)</td></tr><tr><td class="line">402</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">403</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">404</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">405</td><td class="hits">1</td><td class="source">    UserSocket.prototype.update = function(classname, model, fn, time) {</td></tr><tr class="hit"><td class="line">406</td><td class="hits">67</td><td class="source">      var _this = this;</td></tr><tr class="hit"><td class="line">407</td><td class="hits">67</td><td class="source">      return this.sync[classname + '_update'](model, time).then(function(model) {</td></tr><tr class="hit"><td class="line">408</td><td class="hits">31</td><td class="source">        _this.broadcast(classname + '.update', model);</td></tr><tr class="hit"><td class="line">409</td><td class="hits">31</td><td class="source">        if (fn) {</td></tr><tr class="hit"><td class="line">410</td><td class="hits">31</td><td class="source">          return fn(null);</td></tr><tr><td class="line">411</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">412</td><td class="hits"></td><td class="source">      }).fail(function(err) {</td></tr><tr class="hit"><td class="line">413</td><td class="hits">36</td><td class="source">        console.log(err);</td></tr><tr class="hit"><td class="line">414</td><td class="hits">36</td><td class="source">        if (fn) {</td></tr><tr class="hit"><td class="line">415</td><td class="hits">36</td><td class="source">          return fn(true);</td></tr><tr><td class="line">416</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">417</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">418</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">419</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">420</td><td class="hits">1</td><td class="source">    UserSocket.prototype.task_update = function(model, fn, time) {</td></tr><tr class="hit"><td class="line">421</td><td class="hits">15</td><td class="source">      return this.update(TASK, model, fn, time);</td></tr><tr><td class="line">422</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">423</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">424</td><td class="hits">1</td><td class="source">    UserSocket.prototype.list_update = function(model, fn, time) {</td></tr><tr class="hit"><td class="line">425</td><td class="hits">24</td><td class="source">      return this.update(LIST, model, fn, time);</td></tr><tr><td class="line">426</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">427</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">428</td><td class="hits">1</td><td class="source">    UserSocket.prototype.pref_update = function(model, fn, time) {</td></tr><tr class="hit"><td class="line">429</td><td class="hits">28</td><td class="source">      return this.update(PREF, model, fn, time);</td></tr><tr><td class="line">430</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">431</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">432</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">433</td><td class="hits"></td><td class="source">     * Model Destroy</td></tr><tr><td class="line">434</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">435</td><td class="hits"></td><td class="source">     * - model (object)</td></tr><tr><td class="line">436</td><td class="hits"></td><td class="source">     * - [fn] (function)</td></tr><tr><td class="line">437</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">438</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">439</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">440</td><td class="hits">1</td><td class="source">    UserSocket.prototype.destroy = function(classname, model, fn, time) {</td></tr><tr class="hit"><td class="line">441</td><td class="hits">24</td><td class="source">      var id,</td></tr><tr><td class="line">442</td><td class="hits"></td><td class="source">        _this = this;</td></tr><tr class="hit"><td class="line">443</td><td class="hits">24</td><td class="source">      id = model.id;</td></tr><tr class="hit"><td class="line">444</td><td class="hits">24</td><td class="source">      return this.sync[classname + '_destroy'](id, time).then(function() {</td></tr><tr class="hit"><td class="line">445</td><td class="hits">11</td><td class="source">        _this.broadcast(classname + '.destroy', {</td></tr><tr><td class="line">446</td><td class="hits"></td><td class="source">          id: id</td></tr><tr><td class="line">447</td><td class="hits"></td><td class="source">        });</td></tr><tr class="hit"><td class="line">448</td><td class="hits">11</td><td class="source">        if (fn) {</td></tr><tr class="hit"><td class="line">449</td><td class="hits">11</td><td class="source">          return fn(null);</td></tr><tr><td class="line">450</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">451</td><td class="hits"></td><td class="source">      }).fail(function(err) {</td></tr><tr class="hit"><td class="line">452</td><td class="hits">13</td><td class="source">        console.log(err);</td></tr><tr class="hit"><td class="line">453</td><td class="hits">13</td><td class="source">        if (fn) {</td></tr><tr class="hit"><td class="line">454</td><td class="hits">13</td><td class="source">          return fn(true);</td></tr><tr><td class="line">455</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">456</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">457</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">458</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">459</td><td class="hits">1</td><td class="source">    UserSocket.prototype.task_destroy = function(model, fn, time) {</td></tr><tr class="hit"><td class="line">460</td><td class="hits">6</td><td class="source">      return this.destroy(TASK, model, fn, time);</td></tr><tr><td class="line">461</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">462</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">463</td><td class="hits">1</td><td class="source">    UserSocket.prototype.list_destroy = function(model, fn, time) {</td></tr><tr class="hit"><td class="line">464</td><td class="hits">18</td><td class="source">      return this.destroy(LIST, model, fn, time);</td></tr><tr><td class="line">465</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">466</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">467</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">468</td><td class="hits"></td><td class="source">     * Model Sync</td></tr><tr><td class="line">469</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">470</td><td class="hits"></td><td class="source">     * - queue (object)</td></tr><tr><td class="line">471</td><td class="hits"></td><td class="source">     * - fn (function)</td></tr><tr><td class="line">472</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">473</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">474</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">475</td><td class="hits">1</td><td class="source">    UserSocket.prototype.queue_sync = function(queue, fn) {</td></tr><tr class="miss"><td class="line">476</td><td class="hits">0</td><td class="source">      var event, i, id, list, lists, pref, task, taskId, tasks, time, _i, _ref, _ref1, _ref2, _ref3, _ref4, _ref5;</td></tr><tr class="miss"><td class="line">477</td><td class="hits">0</td><td class="source">      lists = {};</td></tr><tr class="miss"><td class="line">478</td><td class="hits">0</td><td class="source">      if (queue.list) {</td></tr><tr class="miss"><td class="line">479</td><td class="hits">0</td><td class="source">        _ref = queue.list;</td></tr><tr class="miss"><td class="line">480</td><td class="hits">0</td><td class="source">        for (id in _ref) {</td></tr><tr class="miss"><td class="line">481</td><td class="hits">0</td><td class="source">          _ref1 = _ref[id], event = _ref1[0], list = _ref1[1], time = _ref1[2];</td></tr><tr class="miss"><td class="line">482</td><td class="hits">0</td><td class="source">          switch (event) {</td></tr><tr><td class="line">483</td><td class="hits"></td><td class="source">            case CREATE:</td></tr><tr class="miss"><td class="line">484</td><td class="hits">0</td><td class="source">              tasks = list.tasks;</td></tr><tr class="miss"><td class="line">485</td><td class="hits">0</td><td class="source">              for (i = _i = tasks.length - 1; _i &gt;= 0; i = _i += -1) {</td></tr><tr class="miss"><td class="line">486</td><td class="hits">0</td><td class="source">                taskId = tasks[i];</td></tr><tr class="miss"><td class="line">487</td><td class="hits">0</td><td class="source">                if (taskId[0] !== SERVER_PREFIX) {</td></tr><tr class="miss"><td class="line">488</td><td class="hits">0</td><td class="source">                  tasks.splice(i, 1);</td></tr><tr><td class="line">489</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">490</td><td class="hits"></td><td class="source">              }</td></tr><tr class="miss"><td class="line">491</td><td class="hits">0</td><td class="source">              list.id = id;</td></tr><tr class="miss"><td class="line">492</td><td class="hits">0</td><td class="source">              lists[id] = this.list_create(list, null, time);</td></tr><tr class="miss"><td class="line">493</td><td class="hits">0</td><td class="source">              break;</td></tr><tr><td class="line">494</td><td class="hits"></td><td class="source">            case UPDATE:</td></tr><tr class="miss"><td class="line">495</td><td class="hits">0</td><td class="source">              list.id = id;</td></tr><tr class="miss"><td class="line">496</td><td class="hits">0</td><td class="source">              this.list_update(list, null, time);</td></tr><tr class="miss"><td class="line">497</td><td class="hits">0</td><td class="source">              break;</td></tr><tr><td class="line">498</td><td class="hits"></td><td class="source">            case DESTROY:</td></tr><tr class="miss"><td class="line">499</td><td class="hits">0</td><td class="source">              this.list_destroy(list, null, time);</td></tr><tr><td class="line">500</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">501</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">502</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">503</td><td class="hits">0</td><td class="source">      if (queue.task) {</td></tr><tr class="miss"><td class="line">504</td><td class="hits">0</td><td class="source">        _ref2 = queue.task;</td></tr><tr class="miss"><td class="line">505</td><td class="hits">0</td><td class="source">        for (id in _ref2) {</td></tr><tr class="miss"><td class="line">506</td><td class="hits">0</td><td class="source">          _ref3 = _ref2[id], event = _ref3[0], task = _ref3[1], time = _ref3[2];</td></tr><tr class="miss"><td class="line">507</td><td class="hits">0</td><td class="source">          switch (event) {</td></tr><tr><td class="line">508</td><td class="hits"></td><td class="source">            case CREATE:</td></tr><tr class="miss"><td class="line">509</td><td class="hits">0</td><td class="source">              task.id = id;</td></tr><tr class="miss"><td class="line">510</td><td class="hits">0</td><td class="source">              if (lists[task.listId]) {</td></tr><tr class="miss"><td class="line">511</td><td class="hits">0</td><td class="source">                task.listId = lists[task.listId];</td></tr><tr><td class="line">512</td><td class="hits"></td><td class="source">              }</td></tr><tr class="miss"><td class="line">513</td><td class="hits">0</td><td class="source">              this.task_create(task, null, time);</td></tr><tr class="miss"><td class="line">514</td><td class="hits">0</td><td class="source">              break;</td></tr><tr><td class="line">515</td><td class="hits"></td><td class="source">            case UPDATE:</td></tr><tr class="miss"><td class="line">516</td><td class="hits">0</td><td class="source">              task.id = id;</td></tr><tr class="miss"><td class="line">517</td><td class="hits">0</td><td class="source">              if ((task.listId != null) &amp;&amp; lists[task.listId]) {</td></tr><tr class="miss"><td class="line">518</td><td class="hits">0</td><td class="source">                task.listId = lists[task.listId];</td></tr><tr><td class="line">519</td><td class="hits"></td><td class="source">              }</td></tr><tr class="miss"><td class="line">520</td><td class="hits">0</td><td class="source">              this.task_update(task, null, time);</td></tr><tr class="miss"><td class="line">521</td><td class="hits">0</td><td class="source">              break;</td></tr><tr><td class="line">522</td><td class="hits"></td><td class="source">            case DESTROY:</td></tr><tr class="miss"><td class="line">523</td><td class="hits">0</td><td class="source">              this.task_destroy(task, null, time);</td></tr><tr><td class="line">524</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">525</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">526</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">527</td><td class="hits">0</td><td class="source">      if (queue.pref) {</td></tr><tr class="miss"><td class="line">528</td><td class="hits">0</td><td class="source">        _ref4 = queue.task;</td></tr><tr class="miss"><td class="line">529</td><td class="hits">0</td><td class="source">        for (id in _ref4) {</td></tr><tr class="miss"><td class="line">530</td><td class="hits">0</td><td class="source">          _ref5 = _ref4[id], event = _ref5[0], pref = _ref5[1], time = _ref5[2];</td></tr><tr class="miss"><td class="line">531</td><td class="hits">0</td><td class="source">          switch (event) {</td></tr><tr><td class="line">532</td><td class="hits"></td><td class="source">            case UPDATE:</td></tr><tr class="miss"><td class="line">533</td><td class="hits">0</td><td class="source">              this.pref_update(pref, null, time);</td></tr><tr><td class="line">534</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">535</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">536</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">537</td><td class="hits">0</td><td class="source">      if (fn) {</td></tr><tr class="miss"><td class="line">538</td><td class="hits">0</td><td class="source">        return fn(null, {</td></tr><tr><td class="line">539</td><td class="hits"></td><td class="source">          list: this.user.exportModel(LIST),</td></tr><tr><td class="line">540</td><td class="hits"></td><td class="source">          task: this.user.exportModel(TASK),</td></tr><tr><td class="line">541</td><td class="hits"></td><td class="source">          pref: this.user.exportModel(PREF)</td></tr><tr><td class="line">542</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">543</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">544</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">545</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">546</td><td class="hits">1</td><td class="source">    return UserSocket;</td></tr><tr><td class="line">547</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">548</td><td class="hits"></td><td class="source">  })(Socket);</td></tr><tr><td class="line">549</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">550</td><td class="hits">1</td><td class="source">  module.exports = {</td></tr><tr><td class="line">551</td><td class="hits"></td><td class="source">    init: init</td></tr><tr><td class="line">552</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">553</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">554</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">555</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/controllers/storage.coffee">/Volumes/Home/Projects/Nitro-Sync/app/controllers/storage.coffee</h2><div id="stats" class="high"><div class="percentage">95%</div><div class="sloc">46</div><div class="hits">44</div><div class="misses">2</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var ERR_BAD_TOKEN, ERR_NO_USER, ERR_OLD_EMAIL, Log, Q, Storage, User, db, log;</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">  Q = require('kew');</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  db = require('../controllers/query');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">  Log = require('../utils/log');</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">  User = require('../models/user');</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">  log = Log('Storage', 'green');</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">  ERR_OLD_EMAIL = 'err_old_email';</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">  ERR_BAD_TOKEN = 'err_bad_token';</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">  ERR_NO_USER = 'err_no_user';</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">  Storage = {</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">     * This will store user data in a temporary key until</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">     * they have verified their account.</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">     * The email used must not exist in the database.</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">     * - token (string) : special id assigned to the data</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">     * - user (object) : { name, email, password }</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">     * &gt; token</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">     * ! err_old_email</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    register: function(token, name, email, password) {</td></tr><tr class="hit"><td class="line">33</td><td class="hits">5</td><td class="source">      return this.emailExists(email).then(function(exists) {</td></tr><tr class="hit"><td class="line">34</td><td class="hits">5</td><td class="source">        if (exists) {</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">          throw ERR_OLD_EMAIL;</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">37</td><td class="hits">5</td><td class="source">        return db.register.create({</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">          token: token,</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">          name: name,</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">          email: email,</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">          password: password</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">     * This will check if registration token exists.</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">     * If the token can't be found an error will be thrown.</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">     * If it is found then the registration will be deleted</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">     * and the user data returned.</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">     * - token (string) : the registration token</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">     * &gt; return user data</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">     * ! err_bad_token</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    getRegistration: function(token) {</td></tr><tr class="hit"><td class="line">57</td><td class="hits">6</td><td class="source">      return db.register.read(token).then(function(data) {</td></tr><tr class="hit"><td class="line">58</td><td class="hits">5</td><td class="source">        db.register.destroy(data.id);</td></tr><tr class="hit"><td class="line">59</td><td class="hits">5</td><td class="source">        return data;</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">      }).fail(function() {</td></tr><tr class="hit"><td class="line">61</td><td class="hits">1</td><td class="source">        throw ERR_BAD_TOKEN;</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">     * This will add a user to the database</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">     * It will then return a new instance of the user</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">     * - user (object) : { name, email, password }</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">     * &gt; User</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">    add: function(user) {</td></tr><tr class="hit"><td class="line">73</td><td class="hits">11</td><td class="source">      var _this = this;</td></tr><tr class="hit"><td class="line">74</td><td class="hits">11</td><td class="source">      return this.emailExists(user.email).then(function(exists) {</td></tr><tr class="hit"><td class="line">75</td><td class="hits">11</td><td class="source">        if (exists) {</td></tr><tr class="hit"><td class="line">76</td><td class="hits">3</td><td class="source">          throw ERR_OLD_EMAIL;</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">78</td><td class="hits">8</td><td class="source">        user.pro = 0;</td></tr><tr class="hit"><td class="line">79</td><td class="hits">8</td><td class="source">        return db.user.create(user).then(function(id) {</td></tr><tr class="hit"><td class="line">80</td><td class="hits">8</td><td class="source">          return db.pref.create({</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">            userId: id</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">          }).then(function() {</td></tr><tr class="hit"><td class="line">83</td><td class="hits">8</td><td class="source">            return _this.get(id);</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">          });</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">     * This will retrive a user from the database by their ID.</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">     * If the user is already loaded in memory, it will return that instance,</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">     * Else it will load it from the database and add it to the records.</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">     * Will return the user as a User instance.</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">     * Will throw an error if the user can't be found.</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">     * - id (int) : The id of the user to get</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">     * &gt; User</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">     * ! err_no_user</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">    get: function(id) {</td></tr><tr class="hit"><td class="line">101</td><td class="hits">46</td><td class="source">      return db.user.read(id, 'id').then(function() {</td></tr><tr class="hit"><td class="line">102</td><td class="hits">43</td><td class="source">        return new User(id);</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">     * Get a user by their email address</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">     * - email (string)</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">     * &gt; user</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">    getByEmail: function(email) {</td></tr><tr class="hit"><td class="line">113</td><td class="hits">10</td><td class="source">      return db.user.search(email).then(this.get, function() {</td></tr><tr class="hit"><td class="line">114</td><td class="hits">2</td><td class="source">        throw ERR_NO_USER;</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">     * Check if an email address exists in the system</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">     * - email (string)</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">     * &gt; boolean</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">    emailExists: function(email) {</td></tr><tr class="hit"><td class="line">125</td><td class="hits">20</td><td class="source">      return db.user.search(email).then(function() {</td></tr><tr class="hit"><td class="line">126</td><td class="hits">6</td><td class="source">        return true;</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">      }).fail(function() {</td></tr><tr class="hit"><td class="line">128</td><td class="hits">14</td><td class="source">        return false;</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">     * Completely remove a user from the system</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">     * We could integrate it with @release(id), but that would write</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">     * it to the database, right before we instantly delete it.</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">     * - id (int) : the user id</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">    destroy: function(id) {</td></tr><tr class="hit"><td class="line">140</td><td class="hits">3</td><td class="source">      log(&quot;Removing user &quot; + id);</td></tr><tr class="hit"><td class="line">141</td><td class="hits">3</td><td class="source">      return db.user.destroy(id);</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">     * Add a new login token.</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">     * It will expire after two weeks.</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">     * - id (int) : the user id</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">     * - token (string) : the login token</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">     * &gt; token</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">    addLoginToken: function(id, token) {</td></tr><tr class="hit"><td class="line">153</td><td class="hits">4</td><td class="source">      return db.login.create(id, token).then(function() {</td></tr><tr class="hit"><td class="line">154</td><td class="hits">4</td><td class="source">        return token;</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">     * Check that a login token is valid</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">     * - id (int) : the user id</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">     * - token (string) : the login token</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">     * &gt; boolean</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">    checkLoginToken: function(id, token) {</td></tr><tr class="hit"><td class="line">166</td><td class="hits">27</td><td class="source">      return db.login.exists(id, token);</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">     * Remove a specific login token</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">     * - id (int) : the user id</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">     * - token (string) : the login token</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">    destroyLoginToken: function(id, token) {</td></tr><tr class="hit"><td class="line">176</td><td class="hits">1</td><td class="source">      return db.login.destroy(id, token);</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">     * Remove all the login tokens for a user</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">     * - id (int) : the user id</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">    destroyAllLoginTokens: function(id) {</td></tr><tr class="miss"><td class="line">185</td><td class="hits">0</td><td class="source">      return db.login.destroyAll(id);</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">     * Add a new password reset token</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">     * Tokens are removed after 12 hours</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">     * - id (int) : the user id</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">     * - token (string) : the reset token</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">     * &gt; database reset token</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">    addResetToken: function(id, token) {</td></tr><tr class="hit"><td class="line">197</td><td class="hits">2</td><td class="source">      return db.reset.create(id, token);</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">     * Check that a reset token is valid</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">     * - token (string) : the reset token</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">     * &gt; int : the user id</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">    checkResetToken: function(token) {</td></tr><tr class="hit"><td class="line">207</td><td class="hits">3</td><td class="source">      return db.reset.read(token).fail(function() {</td></tr><tr class="hit"><td class="line">208</td><td class="hits">2</td><td class="source">        throw ERR_BAD_TOKEN;</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">     * Destroy a reset token</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">     * - token (string) : the reset token</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">    destroyResetToken: function(token) {</td></tr><tr class="hit"><td class="line">218</td><td class="hits">3</td><td class="source">      return db.reset.destroy(token);</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">222</td><td class="hits">1</td><td class="source">  module.exports = Storage;</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/controllers/sync.coffee">/Volumes/Home/Projects/Nitro-Sync/app/controllers/sync.coffee</h2><div id="stats" class="medium"><div class="percentage">53%</div><div class="sloc">170</div><div class="hits">91</div><div class="misses">79</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="source">/*</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">           ___  __   __      __            __</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">    |\ | |  |  |__) /  \    /__` \ / |\ | /  `</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">    | \| |  |  |  \ \__/    .__/  |  | \| \__,</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">    ------------------------------------------</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">    This is the sync code. It's a wee bit crazy.</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">*/</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">  var ERR_INVALID_MODEL, LIST, Log, PREF, Q, Sync, TASK, Time, log, logEvent, warn,</td></tr><tr class="hit"><td class="line">14</td><td class="hits">506</td><td class="source">    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">  Q = require('kew');</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">  Log = require('../utils/log');</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">  Time = require('../utils/time');</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">  log = Log('Sync', 'cyan');</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">  logEvent = Log('Sync Event', 'yellow');</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">  warn = Log('Sync', 'red');</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">  LIST = 'list';</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">  PREF = 'pref';</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">32</td><td class="hits">1</td><td class="source">  TASK = 'task';</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">  ERR_INVALID_MODEL = 'err_invalid_model';</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">36</td><td class="hits">1</td><td class="source">  Sync = (function() {</td></tr><tr class="hit"><td class="line">37</td><td class="hits">1</td><td class="source">    function Sync(user) {</td></tr><tr class="hit"><td class="line">38</td><td class="hits">31</td><td class="source">      this.user = user;</td></tr><tr class="hit"><td class="line">39</td><td class="hits">31</td><td class="source">      this.list_destroy = __bind(this.list_destroy, this);</td></tr><tr class="hit"><td class="line">40</td><td class="hits">31</td><td class="source">      this.task_destroy = __bind(this.task_destroy, this);</td></tr><tr class="hit"><td class="line">41</td><td class="hits">31</td><td class="source">      this.model_destroy_save = __bind(this.model_destroy_save, this);</td></tr><tr class="hit"><td class="line">42</td><td class="hits">31</td><td class="source">      this.model_destroy_timestamp = __bind(this.model_destroy_timestamp, this);</td></tr><tr class="hit"><td class="line">43</td><td class="hits">31</td><td class="source">      this.model_destroy_setup = __bind(this.model_destroy_setup, this);</td></tr><tr class="hit"><td class="line">44</td><td class="hits">31</td><td class="source">      this.pref_update = __bind(this.pref_update, this);</td></tr><tr class="hit"><td class="line">45</td><td class="hits">31</td><td class="source">      this.list_update = __bind(this.list_update, this);</td></tr><tr class="hit"><td class="line">46</td><td class="hits">31</td><td class="source">      this.task_update = __bind(this.task_update, this);</td></tr><tr class="hit"><td class="line">47</td><td class="hits">31</td><td class="source">      this.model_update_setup = __bind(this.model_update_setup, this);</td></tr><tr class="hit"><td class="line">48</td><td class="hits">31</td><td class="source">      this.list_create = __bind(this.list_create, this);</td></tr><tr class="hit"><td class="line">49</td><td class="hits">31</td><td class="source">      this.task_create = __bind(this.task_create, this);</td></tr><tr class="hit"><td class="line">50</td><td class="hits">31</td><td class="source">      this.model_create = __bind(this.model_create, this);</td></tr><tr class="hit"><td class="line">51</td><td class="hits">31</td><td class="source">      this.time = new Time(this.user);</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">     * (private) Create Model</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">     * Assigns an id, saves it to the database and</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">     * also inits the timestamps.</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">     * - classname (string)</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">     * - model (object)</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">     * - [timestamp] (number)</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">     * &gt; id</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">67</td><td class="hits">1</td><td class="source">    Sync.prototype.model_create = function(classname, model, timestamp) {</td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">      this.user.setModel(classname, id, model);</td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">      if (timestamp == null) {</td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="source">        timestamp = Date.now();</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">      this.time.set(classname, id, '*', timestamp);</td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">      log(&quot;[&quot; + classname + &quot;] [create] created&quot;, id);</td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">      return id;</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">     * Create Task</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">     * - model (object)</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">     * - timestamp (number)</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">     * &gt; id (number)</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">86</td><td class="hits">1</td><td class="source">    Sync.prototype.task_create = function(task, timestamp) {</td></tr><tr class="hit"><td class="line">87</td><td class="hits">9</td><td class="source">      var _this = this;</td></tr><tr class="hit"><td class="line">88</td><td class="hits">9</td><td class="source">      return this.user.shouldOwnList(task.listId).then(function(exists) {</td></tr><tr class="hit"><td class="line">89</td><td class="hits">5</td><td class="source">        if (!exists) {</td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="source">          warn('[task] [create] can not find listId', task.listId);</td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="source">          throw ERR_INVALID_MODEL;</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">93</td><td class="hits">5</td><td class="source">        return _this.user.createTask(task);</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">      }).then(function(id) {</td></tr><tr class="hit"><td class="line">95</td><td class="hits">5</td><td class="source">        task.id = id;</td></tr><tr class="hit"><td class="line">96</td><td class="hits">5</td><td class="source">        return _this.user.addTaskToList(id, task.listId).then(function() {</td></tr><tr class="hit"><td class="line">97</td><td class="hits">5</td><td class="source">          return id;</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">     * Create List</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">     * - model (object)</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">     * - timestamp (number)</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">     * &gt; id (number)</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">111</td><td class="hits">1</td><td class="source">    Sync.prototype.list_create = function(list, timestamp) {</td></tr><tr class="hit"><td class="line">112</td><td class="hits">18</td><td class="source">      return this.user.createList(list).then(function(id) {</td></tr><tr class="hit"><td class="line">113</td><td class="hits">18</td><td class="source">        list.id = id;</td></tr><tr class="hit"><td class="line">114</td><td class="hits">18</td><td class="source">        return id;</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">     * (private) Update Model</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">     * Setup update event</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">     * - classname (string)</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">     * - changes (object)</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">     * - timestamps (object)</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">     * &gt; boolean</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">130</td><td class="hits">1</td><td class="source">    Sync.prototype.model_update_setup = function(classname, changes, timestamps) {</td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="source">      var id;</td></tr><tr class="miss"><td class="line">132</td><td class="hits">0</td><td class="source">      id = changes.id;</td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="source">      delete changes.id;</td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="source">      this.user.checkModel(classname, id).then(function(exists) {</td></tr><tr class="miss"><td class="line">135</td><td class="hits">0</td><td class="source">        warn(&quot;[&quot; + classname + &quot;] [update] could not find &quot; + id);</td></tr><tr class="miss"><td class="line">136</td><td class="hits">0</td><td class="source">        return false;</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">      });</td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="source">      return true;</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">     * (private) Model Update Timestamps</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">     * Handle timestamps for an update event</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">     * - classname (string)</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">     * - id (string)</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">     * - changes (object)</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">     * - timestamps (object)</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">     * &gt; timestamps</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">154</td><td class="hits">1</td><td class="source">    Sync.prototype.model_update_timestamps = function(classname, id, changes, timestamps) {</td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="source">      var attr, key, now, old, time;</td></tr><tr class="miss"><td class="line">156</td><td class="hits">0</td><td class="source">      if (timestamps) {</td></tr><tr class="miss"><td class="line">157</td><td class="hits">0</td><td class="source">        for (attr in timestamps) {</td></tr><tr class="miss"><td class="line">158</td><td class="hits">0</td><td class="source">          time = timestamps[attr];</td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="source">          old = this.time.get(classname, id, attr);</td></tr><tr class="miss"><td class="line">160</td><td class="hits">0</td><td class="source">          if (old &gt; time) {</td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="source">            delete timestamps[attr];</td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="source">            delete changes[attr];</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">          }</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">165</td><td class="hits">0</td><td class="source">        if (Object.keys(changes).length === 0) {</td></tr><tr class="miss"><td class="line">166</td><td class="hits">0</td><td class="source">          warn(&quot;[&quot; + classname + &quot;] [update] all properties are old&quot;);</td></tr><tr class="miss"><td class="line">167</td><td class="hits">0</td><td class="source">          return null;</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="source">        timestamps = {};</td></tr><tr class="miss"><td class="line">171</td><td class="hits">0</td><td class="source">        now = Date.now();</td></tr><tr class="miss"><td class="line">172</td><td class="hits">0</td><td class="source">        for (key in changes) {</td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="source">          timestamps[key] = now;</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">176</td><td class="hits">0</td><td class="source">      return timestamps;</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">     * (private) Model Update Save</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">     * Save model changes and timestamps</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">     * - classname (string)</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">     * - id (string)</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">     * - changes (object)</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">     * - timestamps (object)</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">     * &gt; changes</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">192</td><td class="hits">1</td><td class="source">    Sync.prototype.model_update_save = function(classname, id, changes, timestamps) {</td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="source">      log(&quot;[&quot; + classname + &quot;] [update] saved &quot; + id);</td></tr><tr class="miss"><td class="line">194</td><td class="hits">0</td><td class="source">      this.time.set(classname, id, timestamps);</td></tr><tr class="miss"><td class="line">195</td><td class="hits">0</td><td class="source">      this.user.updateModel(classname, id, changes);</td></tr><tr class="miss"><td class="line">196</td><td class="hits">0</td><td class="source">      return changes;</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">     * Update Task</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">     * - changes (object)</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">     * - timestamps</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">     * &gt; changes</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">208</td><td class="hits">1</td><td class="source">    Sync.prototype.task_update = function(changes, timestamps) {</td></tr><tr class="hit"><td class="line">209</td><td class="hits">20</td><td class="source">      var id,</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">        _this = this;</td></tr><tr class="hit"><td class="line">211</td><td class="hits">20</td><td class="source">      id = changes.id;</td></tr><tr class="hit"><td class="line">212</td><td class="hits">20</td><td class="source">      delete changes.id;</td></tr><tr class="hit"><td class="line">213</td><td class="hits">20</td><td class="source">      return this.user.shouldOwnTask(id).then(function() {</td></tr><tr class="hit"><td class="line">214</td><td class="hits">5</td><td class="source">        if (changes.listId != null) {</td></tr><tr class="hit"><td class="line">215</td><td class="hits">1</td><td class="source">          return _this.user.shouldOwnList(changes.listId).then(function() {</td></tr><tr class="hit"><td class="line">216</td><td class="hits">1</td><td class="source">            return _this.user.readTask(id, 'listId');</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">          }).then(function(old) {</td></tr><tr class="hit"><td class="line">218</td><td class="hits">1</td><td class="source">            if (old.listId === changes.listId) {</td></tr><tr class="miss"><td class="line">219</td><td class="hits">0</td><td class="source">              return;</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">221</td><td class="hits">1</td><td class="source">            return _this.user.removeTaskFromList(id, old.listId);</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">          }).fin(function() {</td></tr><tr class="hit"><td class="line">223</td><td class="hits">1</td><td class="source">            return _this.user.addTaskToList(id, changes.listId);</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source">          }).fail(function() {</td></tr><tr class="miss"><td class="line">225</td><td class="hits">0</td><td class="source">            return delete changes.listId;</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source">          }).then(function() {</td></tr><tr class="hit"><td class="line">227</td><td class="hits">1</td><td class="source">            return _this.user.updateTask(id, changes);</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">          });</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">230</td><td class="hits">4</td><td class="source">          return _this.user.updateTask(id, changes);</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">      }).then(function() {</td></tr><tr class="hit"><td class="line">233</td><td class="hits">5</td><td class="source">        changes.id = id;</td></tr><tr class="hit"><td class="line">234</td><td class="hits">5</td><td class="source">        return changes;</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">     * Update List</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">     * - changes (object)</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">     * - timestamps (object)</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source">     * &gt; changes</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">247</td><td class="hits">1</td><td class="source">    Sync.prototype.list_update = function(changes, timestamps) {</td></tr><tr class="hit"><td class="line">248</td><td class="hits">28</td><td class="source">      var id,</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">        _this = this;</td></tr><tr class="hit"><td class="line">250</td><td class="hits">28</td><td class="source">      id = changes.id;</td></tr><tr class="hit"><td class="line">251</td><td class="hits">28</td><td class="source">      return this.user.shouldOwnList(id).then(function() {</td></tr><tr class="hit"><td class="line">252</td><td class="hits">7</td><td class="source">        if (changes.tasks) {</td></tr><tr class="hit"><td class="line">253</td><td class="hits">2</td><td class="source">          warn('[list] [update] TODO: Handle list.tasks');</td></tr><tr class="hit"><td class="line">254</td><td class="hits">2</td><td class="source">          delete changes.tasks;</td></tr><tr class="hit"><td class="line">255</td><td class="hits">2</td><td class="source">          delete timestamps.tasks;</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">257</td><td class="hits">5</td><td class="source">        return _this.user.updateList(id, changes);</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">      }).then(function() {</td></tr><tr class="hit"><td class="line">259</td><td class="hits">5</td><td class="source">        changes.id = id;</td></tr><tr class="hit"><td class="line">260</td><td class="hits">5</td><td class="source">        return changes;</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source">     * Update Pref</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source">     * - changes (object)</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">     * - timestamps (timestamps)</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">     * &gt; changes</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">273</td><td class="hits">1</td><td class="source">    Sync.prototype.pref_update = function(changes, timestamps) {</td></tr><tr class="hit"><td class="line">274</td><td class="hits">29</td><td class="source">      return this.user.updatePref(changes).then(function() {</td></tr><tr class="hit"><td class="line">275</td><td class="hits">29</td><td class="source">        return changes;</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">     * (private) Model Destroy Setup</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">     * Check that model exists, and set the timestamp for it</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">     * - classname (string)</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source">     * - id (string)</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">     * - timestamp (number)</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">     * &gt; model</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">291</td><td class="hits">1</td><td class="source">    Sync.prototype.model_destroy_setup = function(classname, id) {</td></tr><tr class="miss"><td class="line">292</td><td class="hits">0</td><td class="source">      var model;</td></tr><tr class="miss"><td class="line">293</td><td class="hits">0</td><td class="source">      if (!this.user.checkModel(classname, id)) {</td></tr><tr class="miss"><td class="line">294</td><td class="hits">0</td><td class="source">        warn(&quot;[&quot; + classname + &quot;] [destroy] could not find &quot; + id);</td></tr><tr class="miss"><td class="line">295</td><td class="hits">0</td><td class="source">        return null;</td></tr><tr><td class="line">296</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">297</td><td class="hits">0</td><td class="source">      model = this.user.findModel(classname, id);</td></tr><tr class="miss"><td class="line">298</td><td class="hits">0</td><td class="source">      return model;</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">301</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">302</td><td class="hits"></td><td class="source">     * Model Destroy Timestamp</td></tr><tr><td class="line">303</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source">     * Check that the model hasn't been updated after this event</td></tr><tr><td class="line">305</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source">     * - classname (string)</td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source">     * - id (string)</td></tr><tr><td class="line">308</td><td class="hits"></td><td class="source">     * - timestamp (number)</td></tr><tr><td class="line">309</td><td class="hits"></td><td class="source">     * &gt; timestamp</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">312</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">313</td><td class="hits">1</td><td class="source">    Sync.prototype.model_destroy_timestamp = function(classname, id, timestamp) {</td></tr><tr class="miss"><td class="line">314</td><td class="hits">0</td><td class="source">      if (timestamp == null) {</td></tr><tr class="miss"><td class="line">315</td><td class="hits">0</td><td class="source">        timestamp = Date.now();</td></tr><tr><td class="line">316</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">317</td><td class="hits">0</td><td class="source">      if (!this.time.check(classname, id, timestamp)) {</td></tr><tr class="miss"><td class="line">318</td><td class="hits">0</td><td class="source">        warn(&quot;[&quot; + classname + &quot;] [destroy] updated after delete time: &quot; + id);</td></tr><tr class="miss"><td class="line">319</td><td class="hits">0</td><td class="source">        return null;</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">321</td><td class="hits">0</td><td class="source">      return timestamp;</td></tr><tr><td class="line">322</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">323</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source">     * (private) Model Destroy Save</td></tr><tr><td class="line">326</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">327</td><td class="hits"></td><td class="source">     * Overwrite model with deleted object template and</td></tr><tr><td class="line">328</td><td class="hits"></td><td class="source">     * save deleted timestamp.</td></tr><tr><td class="line">329</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">330</td><td class="hits"></td><td class="source">     * - classname (string)</td></tr><tr><td class="line">331</td><td class="hits"></td><td class="source">     * - id (string)</td></tr><tr><td class="line">332</td><td class="hits"></td><td class="source">     * - timestamp (number)</td></tr><tr><td class="line">333</td><td class="hits"></td><td class="source">     * &gt; true</td></tr><tr><td class="line">334</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">335</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">336</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">337</td><td class="hits">1</td><td class="source">    Sync.prototype.model_destroy_save = function(classname, id, timestamp) {</td></tr><tr class="miss"><td class="line">338</td><td class="hits">0</td><td class="source">      this.user.setModel(classname, id, {</td></tr><tr><td class="line">339</td><td class="hits"></td><td class="source">        id: id,</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source">        deleted: true</td></tr><tr><td class="line">341</td><td class="hits"></td><td class="source">      });</td></tr><tr class="miss"><td class="line">342</td><td class="hits">0</td><td class="source">      this.time.set(classname, id, 'deleted', timestamp);</td></tr><tr class="miss"><td class="line">343</td><td class="hits">0</td><td class="source">      log(&quot;[&quot; + classname + &quot;] [destroy] deleted &quot; + id);</td></tr><tr class="miss"><td class="line">344</td><td class="hits">0</td><td class="source">      return true;</td></tr><tr><td class="line">345</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source">     * Destroy Task</td></tr><tr><td class="line">349</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source">     * - id (string)</td></tr><tr><td class="line">351</td><td class="hits"></td><td class="source">     * - timestamp (number)</td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">353</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">354</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">355</td><td class="hits">1</td><td class="source">    Sync.prototype.task_destroy = function(id, timestamp) {</td></tr><tr class="hit"><td class="line">356</td><td class="hits">8</td><td class="source">      var _this = this;</td></tr><tr class="hit"><td class="line">357</td><td class="hits">8</td><td class="source">      return this.user.shouldOwnTask(id).then(function() {</td></tr><tr class="hit"><td class="line">358</td><td class="hits">3</td><td class="source">        return _this.user.destroyTask(id);</td></tr><tr><td class="line">359</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">360</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">361</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">362</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">363</td><td class="hits"></td><td class="source">     * Destroy List</td></tr><tr><td class="line">364</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source">     * - id (string)</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source">     * - timestamp (number)</td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">368</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">369</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">370</td><td class="hits">1</td><td class="source">    Sync.prototype.list_destroy = function(id, timestamp) {</td></tr><tr class="hit"><td class="line">371</td><td class="hits">22</td><td class="source">      var _this = this;</td></tr><tr class="hit"><td class="line">372</td><td class="hits">22</td><td class="source">      return this.user.shouldOwnList(id).then(function() {</td></tr><tr class="hit"><td class="line">373</td><td class="hits">12</td><td class="source">        return _this.user.destroyList(id);</td></tr><tr><td class="line">374</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">375</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">376</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">377</td><td class="hits">1</td><td class="source">    Sync.prototype.taskAdd = function(taskId, list) {</td></tr><tr class="miss"><td class="line">378</td><td class="hits">0</td><td class="source">      var tasks;</td></tr><tr class="miss"><td class="line">379</td><td class="hits">0</td><td class="source">      tasks = list.tasks;</td></tr><tr class="miss"><td class="line">380</td><td class="hits">0</td><td class="source">      if (!tasks) {</td></tr><tr class="miss"><td class="line">381</td><td class="hits">0</td><td class="source">        return false;</td></tr><tr><td class="line">382</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">383</td><td class="hits">0</td><td class="source">      if (tasks.indexOf(taskId) &lt; 0) {</td></tr><tr class="miss"><td class="line">384</td><td class="hits">0</td><td class="source">        tasks.push(taskId);</td></tr><tr class="miss"><td class="line">385</td><td class="hits">0</td><td class="source">        return this.user.save(LIST);</td></tr><tr><td class="line">386</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">387</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">388</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">389</td><td class="hits">1</td><td class="source">    Sync.prototype.taskRemove = function(taskId, list) {</td></tr><tr class="miss"><td class="line">390</td><td class="hits">0</td><td class="source">      var index, tasks;</td></tr><tr class="miss"><td class="line">391</td><td class="hits">0</td><td class="source">      tasks = list.tasks;</td></tr><tr class="miss"><td class="line">392</td><td class="hits">0</td><td class="source">      if (!tasks) {</td></tr><tr class="miss"><td class="line">393</td><td class="hits">0</td><td class="source">        return false;</td></tr><tr><td class="line">394</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">395</td><td class="hits">0</td><td class="source">      index = tasks.indexOf(taskId);</td></tr><tr class="miss"><td class="line">396</td><td class="hits">0</td><td class="source">      if (index &gt;= 0) {</td></tr><tr class="miss"><td class="line">397</td><td class="hits">0</td><td class="source">        tasks.splice(index, 1);</td></tr><tr class="miss"><td class="line">398</td><td class="hits">0</td><td class="source">        return this.user.save(LIST);</td></tr><tr><td class="line">399</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">400</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">401</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">402</td><td class="hits">1</td><td class="source">    Sync.prototype.taskMove = function(taskId, oldListId, newListId) {</td></tr><tr class="miss"><td class="line">403</td><td class="hits">0</td><td class="source">      var list;</td></tr><tr class="miss"><td class="line">404</td><td class="hits">0</td><td class="source">      list = this.user.findModel(LIST, newListId);</td></tr><tr class="miss"><td class="line">405</td><td class="hits">0</td><td class="source">      this.taskAdd(taskId, list);</td></tr><tr class="miss"><td class="line">406</td><td class="hits">0</td><td class="source">      list = this.user.findModel(LIST, oldListId);</td></tr><tr class="miss"><td class="line">407</td><td class="hits">0</td><td class="source">      return this.taskRemove(taskId, list);</td></tr><tr><td class="line">408</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">409</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">410</td><td class="hits">1</td><td class="source">    Sync.prototype.taskUpdateId = function(oldId, newId, listId) {</td></tr><tr class="miss"><td class="line">411</td><td class="hits">0</td><td class="source">      var index, tasks;</td></tr><tr class="miss"><td class="line">412</td><td class="hits">0</td><td class="source">      tasks = this.user.findModel(LIST, listId).tasks;</td></tr><tr class="miss"><td class="line">413</td><td class="hits">0</td><td class="source">      index = tasks.indexOf(oldId);</td></tr><tr class="miss"><td class="line">414</td><td class="hits">0</td><td class="source">      if (index &gt;= 0) {</td></tr><tr class="miss"><td class="line">415</td><td class="hits">0</td><td class="source">        tasks.spice(index, 1, newId);</td></tr><tr class="miss"><td class="line">416</td><td class="hits">0</td><td class="source">        return this.user.save(LIST);</td></tr><tr><td class="line">417</td><td class="hits"></td><td class="source">      }</td></tr><tr><td class="line">418</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">419</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">420</td><td class="hits">1</td><td class="source">    return Sync;</td></tr><tr><td class="line">421</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">422</td><td class="hits"></td><td class="source">  })();</td></tr><tr><td class="line">423</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">424</td><td class="hits">1</td><td class="source">  module.exports = Sync;</td></tr><tr><td class="line">425</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">426</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">427</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/controllers/table.coffee">/Volumes/Home/Projects/Nitro-Sync/app/controllers/table.coffee</h2><div id="stats" class="high"><div class="percentage">98%</div><div class="sloc">72</div><div class="hits">71</div><div class="misses">1</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var Q, Table;</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">  Q = require('kew');</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  Table = (function() {</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">     * Table (string)</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">     * This should store the table name</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">    Table.prototype.table = null;</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">     * Constants</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">    Table.prototype.ERR_NO_ROW = 'err_no_row';</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">     * Table Constructor</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">     * - query (function) : the Knex builder</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">29</td><td class="hits">1</td><td class="source">    function Table(query) {</td></tr><tr class="hit"><td class="line">30</td><td class="hits">8</td><td class="source">      this.query = query;</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">     * Setup</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">     * This will be called after initialization to setup the table.</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">     * It should return a promise so that we can tell when all the tables</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">     * are ready.</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">     * &gt; Promise</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">44</td><td class="hits">1</td><td class="source">    Table.prototype.setup = function() {};</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">     * Wrap</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">     * Converts the Knex builder into a Kew promise</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">     * - fn (Knex) : The knex builder</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">55</td><td class="hits">1</td><td class="source">    Table.prototype.wrap = function(fn) {</td></tr><tr class="hit"><td class="line">56</td><td class="hits">516</td><td class="source">      var deferred;</td></tr><tr class="hit"><td class="line">57</td><td class="hits">516</td><td class="source">      deferred = Q.defer();</td></tr><tr class="hit"><td class="line">58</td><td class="hits">516</td><td class="source">      fn.exec(deferred.makeNodeResolver());</td></tr><tr class="hit"><td class="line">59</td><td class="hits">516</td><td class="source">      return deferred.promise;</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">     * (private) Create Table</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">     * Creates a table if it does not already exist</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">     * - fn (function) : will be passed to knex.schema.createTable</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">71</td><td class="hits">1</td><td class="source">    Table.prototype._createTable = function(fn) {</td></tr><tr class="hit"><td class="line">72</td><td class="hits">8</td><td class="source">      var promise,</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">        _this = this;</td></tr><tr class="hit"><td class="line">74</td><td class="hits">8</td><td class="source">      promise = this.wrap(this.query.schema.hasTable(this.table));</td></tr><tr class="hit"><td class="line">75</td><td class="hits">8</td><td class="source">      return promise.then(function(exists) {</td></tr><tr class="hit"><td class="line">76</td><td class="hits">8</td><td class="source">        if (exists) {</td></tr><tr class="hit"><td class="line">77</td><td class="hits">8</td><td class="source">          return;</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">        return _this.wrap(_this.query.schema.createTable(_this.table, fn));</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">83</td><td class="hits">1</td><td class="source">    Table.prototype._true = function() {</td></tr><tr class="hit"><td class="line">84</td><td class="hits">29</td><td class="source">      return true;</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">87</td><td class="hits">1</td><td class="source">    Table.prototype._false = function() {</td></tr><tr class="hit"><td class="line">88</td><td class="hits">8</td><td class="source">      return false;</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">91</td><td class="hits">1</td><td class="source">    Table.prototype._parseToken = function(token) {</td></tr><tr class="hit"><td class="line">92</td><td class="hits">19</td><td class="source">      var match;</td></tr><tr class="hit"><td class="line">93</td><td class="hits">19</td><td class="source">      match = token.match(/^(\d+)_(\w+)$/);</td></tr><tr class="hit"><td class="line">94</td><td class="hits">19</td><td class="source">      if (match === null) {</td></tr><tr class="hit"><td class="line">95</td><td class="hits">5</td><td class="source">        return null;</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">97</td><td class="hits">14</td><td class="source">      return [match[1], match[2]];</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">100</td><td class="hits">1</td><td class="source">    Table.prototype._search = function(columns, data) {</td></tr><tr class="hit"><td class="line">101</td><td class="hits">311</td><td class="source">      var promise,</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">        _this = this;</td></tr><tr class="hit"><td class="line">103</td><td class="hits">311</td><td class="source">      promise = this.wrap(this.query(this.table).select().column(columns).where(data));</td></tr><tr class="hit"><td class="line">104</td><td class="hits">311</td><td class="source">      return promise.then(function(rows) {</td></tr><tr class="hit"><td class="line">105</td><td class="hits">311</td><td class="source">        if (!rows.length) {</td></tr><tr class="hit"><td class="line">106</td><td class="hits">117</td><td class="source">          throw _this.ERR_NO_ROW;</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">108</td><td class="hits">194</td><td class="source">        return rows;</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">112</td><td class="hits">1</td><td class="source">    Table.prototype._update = function(data, where) {</td></tr><tr class="hit"><td class="line">113</td><td class="hits">52</td><td class="source">      var promise,</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">        _this = this;</td></tr><tr class="hit"><td class="line">115</td><td class="hits">52</td><td class="source">      promise = this.wrap(this.query(this.table).update(data).where(where));</td></tr><tr class="hit"><td class="line">116</td><td class="hits">52</td><td class="source">      return promise.then(function(rows) {</td></tr><tr class="hit"><td class="line">117</td><td class="hits">51</td><td class="source">        if (!rows) {</td></tr><tr class="hit"><td class="line">118</td><td class="hits">3</td><td class="source">          throw _this.ERR_NO_ROW;</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">120</td><td class="hits">48</td><td class="source">        return rows;</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">124</td><td class="hits">1</td><td class="source">    Table.prototype._delete = function(data) {</td></tr><tr class="hit"><td class="line">125</td><td class="hits">48</td><td class="source">      var promise,</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">        _this = this;</td></tr><tr class="hit"><td class="line">127</td><td class="hits">48</td><td class="source">      promise = this.wrap(this.query(this.table).del().where(data));</td></tr><tr class="hit"><td class="line">128</td><td class="hits">48</td><td class="source">      return promise.then(function(rows) {</td></tr><tr class="hit"><td class="line">129</td><td class="hits">48</td><td class="source">        if (!rows) {</td></tr><tr class="hit"><td class="line">130</td><td class="hits">6</td><td class="source">          throw _this.ERR_NO_ROW;</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">132</td><td class="hits">42</td><td class="source">        return true;</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">     * Create</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">     * Create a new row</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">     * - data (object) : the data data</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">     * &gt; id (number) : the new id of the user</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">146</td><td class="hits">1</td><td class="source">    Table.prototype.create = function(data) {</td></tr><tr class="hit"><td class="line">147</td><td class="hits">97</td><td class="source">      var promise;</td></tr><tr class="hit"><td class="line">148</td><td class="hits">97</td><td class="source">      promise = this.wrap(this.query(this.table).insert(data));</td></tr><tr class="hit"><td class="line">149</td><td class="hits">97</td><td class="source">      return promise.then(function(id) {</td></tr><tr class="hit"><td class="line">150</td><td class="hits">95</td><td class="source">        return id[0];</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">     * Read</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">     * Retrieve data from an existing row.</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">     * - id (number) : id of the row</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">     * - [columns] (array|string) : columns to retrieve</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">     * &gt; row (object) : the row data</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">     * ! err_no_row : row cannot be found</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">166</td><td class="hits">1</td><td class="source">    Table.prototype.read = function(id, columns) {</td></tr><tr class="hit"><td class="line">167</td><td class="hits">90</td><td class="source">      var promise;</td></tr><tr class="hit"><td class="line">168</td><td class="hits">90</td><td class="source">      promise = this._search(columns, {</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">        id: id</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">      });</td></tr><tr class="hit"><td class="line">171</td><td class="hits">90</td><td class="source">      return promise.then(function(rows) {</td></tr><tr class="hit"><td class="line">172</td><td class="hits">78</td><td class="source">        return rows[0];</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">176</td><td class="hits">1</td><td class="source">    Table.prototype.exists = function(id) {</td></tr><tr class="hit"><td class="line">177</td><td class="hits">2</td><td class="source">      var promise;</td></tr><tr class="hit"><td class="line">178</td><td class="hits">2</td><td class="source">      promise = this._search('id', {</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">        id: id</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">      });</td></tr><tr class="hit"><td class="line">181</td><td class="hits">2</td><td class="source">      return promise.then(this._true, this._false);</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">     * Update</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">     * Update attributes in an existing row.</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">     * - id (number) : the id of the row</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">     * - data (object) : attributes to set in the row</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">     * &gt; id (number)</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">     * ! err_no_row : row cannot be found</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">196</td><td class="hits">1</td><td class="source">    Table.prototype.update = function(id, data) {</td></tr><tr class="hit"><td class="line">197</td><td class="hits">21</td><td class="source">      return this._update(data, {</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">        id: id</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">     * Destroy</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">     * Destroy an existing row.</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">     * - id (number) : id of row to destroy</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">     * &gt; true</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">     * ! err_no_row : row cannot be found</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">213</td><td class="hits">1</td><td class="source">    Table.prototype.destroy = function(id) {</td></tr><tr class="hit"><td class="line">214</td><td class="hits">34</td><td class="source">      return this._delete({</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">        id: id</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">219</td><td class="hits">1</td><td class="source">    return Table;</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">  })();</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">223</td><td class="hits">1</td><td class="source">  module.exports = Table;</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/controllers/validation.coffee">/Volumes/Home/Projects/Nitro-Sync/app/controllers/validation.coffee</h2><div id="stats" class="high"><div class="percentage">95%</div><div class="sloc">47</div><div class="hits">45</div><div class="misses">2</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var define, defineFn, _ref;</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">  _ref = require('xtype'), define = _ref.define, defineFn = _ref.defineFn;</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  define('Task', 'object', {</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">    keys: {</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">      id: 'number',</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">      listId: 'number',</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">      date: 'number',</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">      name: 'string',</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">      notes: 'string',</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">      priority: 'number',</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">      completed: 'number'</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">  define('TaskCollection', 'array', {</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    all: 'number'</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">  define('List', 'object', {</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    keys: {</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">      id: 'number',</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">      name: 'string',</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">      tasks: 'TaskCollection'</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">  define('Pref', 'object', {</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">    keys: {</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">      sort: 'number',</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">      night: 'number',</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">      language: 'string',</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">      weekStart: 'number',</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">      dateFormat: 'string',</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">      confirmDelete: 'number',</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">      moveCompleted: 'number'</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">42</td><td class="hits">1</td><td class="source">  define('CreateList', 'object', {</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">    required: ['id', 'name', 'tasks'],</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">    inherit: 'List'</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">47</td><td class="hits">1</td><td class="source">  define('UpdateList', 'object', {</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">    required: ['id'],</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">    inherit: 'List'</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">52</td><td class="hits">1</td><td class="source">  define('DestroyList', 'object', {</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">    required: ['id'],</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">    inherit: 'List'</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">57</td><td class="hits">1</td><td class="source">  define('CreateTask', 'object', {</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">    required: ['id', 'listId', 'date', 'name', 'notes', 'priority', 'completed'],</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">    inherit: 'Task'</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">62</td><td class="hits">1</td><td class="source">  define('UpdateTask', 'object', {</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">    required: ['id'],</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">    inherit: 'Task'</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">67</td><td class="hits">1</td><td class="source">  define('DestroyTask', 'object', {</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">    required: ['id'],</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">    inherit: 'Task'</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">72</td><td class="hits">1</td><td class="source">  define('Timestamps', 'object', {</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">    all: 'number'</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">76</td><td class="hits">1</td><td class="source">  define('CreateEvent', 'array', {</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">    keys: {</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">      2: 'number'</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">82</td><td class="hits">1</td><td class="source">  define('UpdateEvent', 'array', {</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">    keys: {</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">      2: 'Timestamps'</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">88</td><td class="hits">1</td><td class="source">  define('DestroyEvent', 'array', {</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">    keys: {</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">      2: 'number'</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">94</td><td class="hits">1</td><td class="source">  define('TaskCreateEvent', 'array', {</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">    inherit: 'CreateEvent',</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">    keys: {</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">      1: 'CreateTask'</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">101</td><td class="hits">1</td><td class="source">  define('TaskUpdateEvent', 'array', {</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">    inherit: 'UpdateEvent',</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">    keys: {</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">      1: 'UpdateTask'</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">108</td><td class="hits">1</td><td class="source">  define('TaskDestroyEvent', 'array', {</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">    inherit: 'DestroyEvent',</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">    keys: {</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">      1: 'DestroyTask'</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">115</td><td class="hits">1</td><td class="source">  define('ListCreateEvent', 'array', {</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">    inherit: 'CreateEvent',</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">    keys: {</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">      1: 'CreateList'</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">122</td><td class="hits">1</td><td class="source">  define('ListUpdateEvent', 'array', {</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">    inherit: 'UpdateEvent',</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">    keys: {</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">      1: 'UpdateList'</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">129</td><td class="hits">1</td><td class="source">  define('ListDestroyEvent', 'array', {</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">    inherit: 'DestroyEvent',</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">    keys: {</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">      1: 'DestroyList'</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">136</td><td class="hits">1</td><td class="source">  define('TaskQueueEvent', 'array', {</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">    inherit: ['TaskCreateEvent', 'TaskUpdateEvent', 'TaskDestroyEvent'],</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">    check: function(arr) {</td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="source">      return arr[0];</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">143</td><td class="hits">1</td><td class="source">  define('ListQueueEvent', 'array', {</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">    inherit: ['ListCreateEvent', 'ListUpdateEvent', 'ListDestroyEvent'],</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">    check: function(arr) {</td></tr><tr class="miss"><td class="line">146</td><td class="hits">0</td><td class="source">      return arr[0];</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">150</td><td class="hits">1</td><td class="source">  define('TaskEvent', 'array', {</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">    inherit: 'TaskQueueEvent',</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">    keys: {</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">      0: 'number'</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">    required: [0, 1, 2]</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">158</td><td class="hits">1</td><td class="source">  define('ListEvent', 'array', {</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">    inherit: 'ListQueueEvent',</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">    keys: {</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">      0: 'number'</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">    required: [0, 1, 2]</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">166</td><td class="hits">1</td><td class="source">  define('PrefEvent', 'array', {</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">    keys: {</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">      0: 'number',</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">      1: 'Pref',</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">      2: 'Timestamps'</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">    required: [0, 1, 2]</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">175</td><td class="hits">1</td><td class="source">  define('TaskQueue', 'object', {</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">    all: 'TaskEvent'</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">179</td><td class="hits">1</td><td class="source">  define('ListQueue', 'object', {</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">    all: 'ListEvent'</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">183</td><td class="hits">1</td><td class="source">  define('PrefQueue', 'object', {</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">    all: 'PrefEvent'</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">187</td><td class="hits">1</td><td class="source">  define('Queue', 'object', {</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">    keys: {</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">      task: 'TaskQueue',</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">      list: 'ListQueue',</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">      pref: 'PrefQueue'</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">  });</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">195</td><td class="hits">1</td><td class="source">  defineFn('user_auth', 'number', 'string', 'function');</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">197</td><td class="hits">1</td><td class="source">  defineFn('user_info', 'function');</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">199</td><td class="hits">1</td><td class="source">  defineFn('task_fetch', 'function');</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">201</td><td class="hits">1</td><td class="source">  defineFn('list_fetch', 'function');</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">203</td><td class="hits">1</td><td class="source">  defineFn('pref_fetch', 'function');</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">205</td><td class="hits">1</td><td class="source">  defineFn('task_create', 'CreateTask', 'function');</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">207</td><td class="hits">1</td><td class="source">  defineFn('list_create', 'CreateList', 'function');</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">209</td><td class="hits">1</td><td class="source">  defineFn('task_update', 'UpdateTask', '~function');</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">211</td><td class="hits">1</td><td class="source">  defineFn('list_update', 'UpdateList', '~function');</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">213</td><td class="hits">1</td><td class="source">  defineFn('pref_update', 'Pref', '~function');</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">215</td><td class="hits">1</td><td class="source">  defineFn('task_destroy', 'DestroyTask', '~function');</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">217</td><td class="hits">1</td><td class="source">  defineFn('list_destroy', 'DestroyList', '~function');</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">219</td><td class="hits">1</td><td class="source">  defineFn('queue_sync', 'Queue', 'function');</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/database/list.coffee">/Volumes/Home/Projects/Nitro-Sync/app/database/list.coffee</h2><div id="stats" class="high"><div class="percentage">83%</div><div class="sloc">18</div><div class="hits">15</div><div class="misses">3</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var List, Table, _ref,</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">    __hasProp = {}.hasOwnProperty,</td></tr><tr class="hit"><td class="line">4</td><td class="hits">7</td><td class="source">    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  Table = require('../controllers/table');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">  List = (function(_super) {</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    __extends(List, _super);</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    function List() {</td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">      _ref = List.__super__.constructor.apply(this, arguments);</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">      return _ref;</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">    List.prototype.table = 'list';</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">    List.prototype.setup = function() {</td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">      var _this = this;</td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">      return this._createTable(function(table) {</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">        table.increments('id').unsigned();</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">        table.integer('userId').unsigned().index().references('id').inTable('user').onDelete('cascade').onUpdate('cascade');</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">        return table.string('name', 150);</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">    return List;</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">  })(Table);</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">  module.exports = List;</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/database/list_tasks.coffee">/Volumes/Home/Projects/Nitro-Sync/app/database/list_tasks.coffee</h2><div id="stats" class="high"><div class="percentage">87%</div><div class="sloc">33</div><div class="hits">29</div><div class="misses">4</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var ListTasks, Table, _ref,</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">    __hasProp = {}.hasOwnProperty,</td></tr><tr class="hit"><td class="line">4</td><td class="hits">7</td><td class="source">    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  Table = require('../controllers/table');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">  ListTasks = (function(_super) {</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    __extends(ListTasks, _super);</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    function ListTasks() {</td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">      _ref = ListTasks.__super__.constructor.apply(this, arguments);</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">      return _ref;</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">    ListTasks.prototype.table = 'list_tasks';</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">    ListTasks.prototype.setup = function() {</td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">      var _this = this;</td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">      return this._createTable(function(table) {</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">        table.primary(['listId', 'taskId']);</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">        table.integer('listId').unsigned().references('id').inTable('list').onDelete('cascade').onUpdate('cascade');</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">        return table.integer('taskId').unsigned().references('id').inTable('task').onDelete('cascade').onUpdate('cascade');</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">    ListTasks.prototype.create = function(list, task) {</td></tr><tr class="hit"><td class="line">28</td><td class="hits">11</td><td class="source">      return ListTasks.__super__.create.call(this, {</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        listId: list,</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        taskId: task</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">    ListTasks.prototype.read = function(list) {</td></tr><tr class="hit"><td class="line">35</td><td class="hits">28</td><td class="source">      var promise;</td></tr><tr class="hit"><td class="line">36</td><td class="hits">28</td><td class="source">      promise = this._search('taskId', {</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        listId: list</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">      });</td></tr><tr class="hit"><td class="line">39</td><td class="hits">28</td><td class="source">      return promise.then(function(rows) {</td></tr><tr class="hit"><td class="line">40</td><td class="hits">10</td><td class="source">        return rows.map(function(row) {</td></tr><tr class="hit"><td class="line">41</td><td class="hits">17</td><td class="source">          return row.taskId;</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">      }).fail(function() {</td></tr><tr class="hit"><td class="line">44</td><td class="hits">18</td><td class="source">        return [];</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">48</td><td class="hits">1</td><td class="source">    ListTasks.prototype.update = function() {</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">      throw new Error('Cannot update list_tasks');</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">52</td><td class="hits">1</td><td class="source">    ListTasks.prototype.destroy = function(list, task) {</td></tr><tr class="hit"><td class="line">53</td><td class="hits">3</td><td class="source">      return this._delete({</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">        listId: list,</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">        taskId: task</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">59</td><td class="hits">1</td><td class="source">    ListTasks.prototype.destroyAll = function(list) {</td></tr><tr class="hit"><td class="line">60</td><td class="hits">1</td><td class="source">      return this._delete({</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        listId: list</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">65</td><td class="hits">1</td><td class="source">    return ListTasks;</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">  })(Table);</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">69</td><td class="hits">1</td><td class="source">  module.exports = ListTasks;</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/database/login.coffee">/Volumes/Home/Projects/Nitro-Sync/app/database/login.coffee</h2><div id="stats" class="high"><div class="percentage">86%</div><div class="sloc">36</div><div class="hits">31</div><div class="misses">5</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var Login, Table, _ref,</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">    __hasProp = {}.hasOwnProperty,</td></tr><tr class="hit"><td class="line">4</td><td class="hits">7</td><td class="source">    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  Table = require('../controllers/table');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">  Login = (function(_super) {</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    __extends(Login, _super);</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    function Login() {</td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">      _ref = Login.__super__.constructor.apply(this, arguments);</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">      return _ref;</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">    Login.prototype.table = 'login';</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">    Login.prototype.setup = function() {</td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">      var _this = this;</td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">      return this._createTable(function(table) {</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">        table.primary(['userid', 'token']);</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">        table.integer('userId').unsigned().references('id').inTable('user').onDelete('cascade').onUpdate('cascade');</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">        table.string('token', 64);</td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">        return table.timestamp('created_at').defaultTo(_this.query.raw('now()'));</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">    Login.prototype.create = function(id, token) {</td></tr><tr class="hit"><td class="line">29</td><td class="hits">8</td><td class="source">      return Login.__super__.create.call(this, {</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        userId: id,</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        token: token</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">     * Read</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">     * Retrieve data from an existing row.</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">     * - id (number) : id of the row</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">     * - [columns] (array|string) : columns to retrieve</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">     * &gt; row (object) : the row data</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">     * ! err_no_row : row cannot be found</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">47</td><td class="hits">1</td><td class="source">    Login.prototype.read = function(id, token, columns) {</td></tr><tr class="hit"><td class="line">48</td><td class="hits">3</td><td class="source">      var promise;</td></tr><tr class="hit"><td class="line">49</td><td class="hits">3</td><td class="source">      promise = this._search(columns, {</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">        userId: id,</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        token: token</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">      });</td></tr><tr class="hit"><td class="line">53</td><td class="hits">3</td><td class="source">      return promise.then(function(rows) {</td></tr><tr class="hit"><td class="line">54</td><td class="hits">2</td><td class="source">        return rows[0];</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">58</td><td class="hits">1</td><td class="source">    Login.prototype.exists = function(id, token) {</td></tr><tr class="hit"><td class="line">59</td><td class="hits">35</td><td class="source">      var promise;</td></tr><tr class="hit"><td class="line">60</td><td class="hits">35</td><td class="source">      promise = this._search('userId', {</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        userId: id,</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        token: token</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">      });</td></tr><tr class="hit"><td class="line">64</td><td class="hits">35</td><td class="source">      return promise.then(this._true, this._false);</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">67</td><td class="hits">1</td><td class="source">    Login.prototype.update = function() {</td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">      throw new Error('Cannot update login row');</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">71</td><td class="hits">1</td><td class="source">    Login.prototype.destroy = function(id, token) {</td></tr><tr class="hit"><td class="line">72</td><td class="hits">2</td><td class="source">      return this._delete({</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">        userId: id,</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">        token: token</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">78</td><td class="hits">1</td><td class="source">    Login.prototype.destroyAll = function(id) {</td></tr><tr class="hit"><td class="line">79</td><td class="hits">2</td><td class="source">      return this._delete({</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">        userId: id</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">84</td><td class="hits">1</td><td class="source">    return Login;</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">  })(Table);</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">88</td><td class="hits">1</td><td class="source">  module.exports = Login;</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/database/pref.coffee">/Volumes/Home/Projects/Nitro-Sync/app/database/pref.coffee</h2><div id="stats" class="high"><div class="percentage">77%</div><div class="sloc">36</div><div class="hits">28</div><div class="misses">8</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var Pref, Table, _ref,</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">    __hasProp = {}.hasOwnProperty,</td></tr><tr class="hit"><td class="line">4</td><td class="hits">7</td><td class="source">    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  Table = require('../controllers/table');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">  Pref = (function(_super) {</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    __extends(Pref, _super);</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    function Pref() {</td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">      _ref = Pref.__super__.constructor.apply(this, arguments);</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">      return _ref;</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">    Pref.prototype.table = 'pref';</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">    Pref.prototype.setup = function() {</td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">      var _this = this;</td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">      return this._createTable(function(table) {</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">        table.integer('userId').unsigned().primary().references('id').inTable('user').onDelete('cascade').onUpdate('cascade');</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">        table.boolean('sort').unsigned();</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">        table.integer('night').unsigned();</td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">        table.string('language', 5);</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">        table.integer('weekStart').unsigned();</td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">        table.string('dateFormat', 8);</td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">        table.boolean('confirmDelete').unsigned();</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">        return table.integer('moveCompleted').unsigned();</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">     * Read</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">     * Retrieve data from an existing row.</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">     * - id (number) : id of the row</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">     * - [columns] (array|string) : columns to retrieve</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">     * &gt; row (object) : the row data</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">     * ! err_no_row : row cannot be found</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">44</td><td class="hits">1</td><td class="source">    Pref.prototype.read = function(id, columns) {</td></tr><tr class="hit"><td class="line">45</td><td class="hits">7</td><td class="source">      var promise,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        _this = this;</td></tr><tr class="hit"><td class="line">47</td><td class="hits">7</td><td class="source">      promise = this._search(columns, {</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">        userid: id</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">      });</td></tr><tr class="hit"><td class="line">50</td><td class="hits">7</td><td class="source">      return promise.then(function(rows) {</td></tr><tr class="hit"><td class="line">51</td><td class="hits">6</td><td class="source">        return rows[0];</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">     * Update</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">     * Update attributes in an existing row.</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">     * Does not care if the row does not exist</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">     * - id (number) : the id of the user</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">     * - data (object) : attributes to set in the row</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">     * &gt; id (number)</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">67</td><td class="hits">1</td><td class="source">    Pref.prototype.update = function(id, data) {</td></tr><tr class="hit"><td class="line">68</td><td class="hits">31</td><td class="source">      var promise;</td></tr><tr class="hit"><td class="line">69</td><td class="hits">31</td><td class="source">      promise = this._update(data, {</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        userId: id</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">      });</td></tr><tr class="hit"><td class="line">72</td><td class="hits">31</td><td class="source">      return promise.then((function() {</td></tr><tr class="hit"><td class="line">73</td><td class="hits">30</td><td class="source">        return id;</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">      }), (function() {</td></tr><tr class="hit"><td class="line">75</td><td class="hits">1</td><td class="source">        return id;</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">      }));</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">     * Destroy</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">     * Destroy an existing row.</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">     * - id (number) : id of row to destroy</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">     * &gt; true</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">     * ! err_no_row : row cannot be found</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">90</td><td class="hits">1</td><td class="source">    Pref.prototype.destroy = function(id) {</td></tr><tr class="hit"><td class="line">91</td><td class="hits">3</td><td class="source">      return this._delete({</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">        userId: id</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">96</td><td class="hits">1</td><td class="source">    return Pref;</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">  })(Table);</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">100</td><td class="hits">1</td><td class="source">  module.exports = Pref;</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/database/register.coffee">/Volumes/Home/Projects/Nitro-Sync/app/database/register.coffee</h2><div id="stats" class="high"><div class="percentage">80%</div><div class="sloc">35</div><div class="hits">28</div><div class="misses">7</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var Q, Register, Table, _ref,</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">    __hasProp = {}.hasOwnProperty,</td></tr><tr class="hit"><td class="line">4</td><td class="hits">7</td><td class="source">    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  Q = require('kew');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">  Table = require('../controllers/table');</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">  Register = (function(_super) {</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    __extends(Register, _super);</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">    function Register() {</td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">      _ref = Register.__super__.constructor.apply(this, arguments);</td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">      return _ref;</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">    Register.prototype.table = 'register';</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">    Register.prototype.setup = function() {</td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">      var _this = this;</td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">      return this._createTable(function(table) {</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">        table.increments('id').unsigned();</td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">        table.string('token', 22);</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">        table.string('name', 100);</td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">        table.string('email', 100);</td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">        table.string('password', 60);</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">        return table.timestamp('created_at').defaultTo(_this.query.raw('now()'));</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">32</td><td class="hits">1</td><td class="source">    Register.prototype.create = function(data) {</td></tr><tr class="hit"><td class="line">33</td><td class="hits">6</td><td class="source">      return Register.__super__.create.call(this, data).then(function(id) {</td></tr><tr class="hit"><td class="line">34</td><td class="hits">6</td><td class="source">        return id + '_' + data.token;</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">38</td><td class="hits">1</td><td class="source">    Register.prototype.read = function(token) {</td></tr><tr class="hit"><td class="line">39</td><td class="hits">9</td><td class="source">      var match, promise;</td></tr><tr class="hit"><td class="line">40</td><td class="hits">9</td><td class="source">      match = this._parseToken(token);</td></tr><tr class="hit"><td class="line">41</td><td class="hits">9</td><td class="source">      if (!match) {</td></tr><tr class="hit"><td class="line">42</td><td class="hits">2</td><td class="source">        return Q.reject('err_invalid_token');</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">44</td><td class="hits">7</td><td class="source">      promise = this._search(['id', 'name', 'email', 'password'], {</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        id: match[0],</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        token: match[1]</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">      });</td></tr><tr class="hit"><td class="line">48</td><td class="hits">7</td><td class="source">      return promise.then(function(rows) {</td></tr><tr class="hit"><td class="line">49</td><td class="hits">6</td><td class="source">        return rows[0];</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">53</td><td class="hits">1</td><td class="source">    Register.prototype.update = function() {</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">      throw new Error('Cannot update registration');</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">57</td><td class="hits">1</td><td class="source">    return Register;</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">  })(Table);</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">61</td><td class="hits">1</td><td class="source">  module.exports = Register;</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/database/reset.coffee">/Volumes/Home/Projects/Nitro-Sync/app/database/reset.coffee</h2><div id="stats" class="high"><div class="percentage">87%</div><div class="sloc">39</div><div class="hits">34</div><div class="misses">5</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var Q, Reset, Table, _ref,</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">    __hasProp = {}.hasOwnProperty,</td></tr><tr class="hit"><td class="line">4</td><td class="hits">7</td><td class="source">    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  Q = require('kew');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">  Table = require('../controllers/table');</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">  Reset = (function(_super) {</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    __extends(Reset, _super);</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">    function Reset() {</td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">      _ref = Reset.__super__.constructor.apply(this, arguments);</td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">      return _ref;</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">    Reset.prototype.table = 'reset';</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">    Reset.prototype.setup = function() {</td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">      var _this = this;</td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">      return this._createTable(function(table) {</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">        table.primary(['userId', 'token']);</td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">        table.integer('userId').unsigned().references('id').inTable('user').onDelete('cascade').onUpdate('cascade');</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">        table.string('token', 22);</td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">        return table.timestamp('created_at').defaultTo(_this.query.raw('now()'));</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">    Reset.prototype.create = function(id, token) {</td></tr><tr class="hit"><td class="line">31</td><td class="hits">3</td><td class="source">      return Reset.__super__.create.call(this, {</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        userId: id,</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        token: token</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">      }).then(function() {</td></tr><tr class="hit"><td class="line">35</td><td class="hits">3</td><td class="source">        return id + '_' + token;</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">    Reset.prototype.read = function(token) {</td></tr><tr class="hit"><td class="line">40</td><td class="hits">6</td><td class="source">      var match, promise;</td></tr><tr class="hit"><td class="line">41</td><td class="hits">6</td><td class="source">      match = this._parseToken(token);</td></tr><tr class="hit"><td class="line">42</td><td class="hits">6</td><td class="source">      if (!match) {</td></tr><tr class="hit"><td class="line">43</td><td class="hits">2</td><td class="source">        return Q.reject('err_invalid_token');</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">45</td><td class="hits">4</td><td class="source">      promise = this._search('userId', {</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        userId: match[0],</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        token: match[1]</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">      });</td></tr><tr class="hit"><td class="line">49</td><td class="hits">4</td><td class="source">      return promise.then(function(rows) {</td></tr><tr class="hit"><td class="line">50</td><td class="hits">2</td><td class="source">        return rows[0].userId;</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">54</td><td class="hits">1</td><td class="source">    Reset.prototype.update = function() {</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">      throw new Error('Cannot update a reset token');</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">58</td><td class="hits">1</td><td class="source">    Reset.prototype.destroy = function(token) {</td></tr><tr class="hit"><td class="line">59</td><td class="hits">4</td><td class="source">      var match;</td></tr><tr class="hit"><td class="line">60</td><td class="hits">4</td><td class="source">      match = this._parseToken(token);</td></tr><tr class="hit"><td class="line">61</td><td class="hits">4</td><td class="source">      if (!match) {</td></tr><tr class="hit"><td class="line">62</td><td class="hits">1</td><td class="source">        return Q.reject('err_invalid_token');</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">      }</td></tr><tr class="hit"><td class="line">64</td><td class="hits">3</td><td class="source">      return this._delete({</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">        userId: match[0],</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">        token: match[1]</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">70</td><td class="hits">1</td><td class="source">    return Reset;</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">  })(Table);</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">74</td><td class="hits">1</td><td class="source">  module.exports = Reset;</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/database/task.coffee">/Volumes/Home/Projects/Nitro-Sync/app/database/task.coffee</h2><div id="stats" class="medium"><div class="percentage">65%</div><div class="sloc">23</div><div class="hits">15</div><div class="misses">8</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var Table, Task, _ref,</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">    __hasProp = {}.hasOwnProperty,</td></tr><tr class="hit"><td class="line">4</td><td class="hits">7</td><td class="source">    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  Table = require('../controllers/table');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">  Task = (function(_super) {</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    __extends(Task, _super);</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    function Task() {</td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">      _ref = Task.__super__.constructor.apply(this, arguments);</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">      return _ref;</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">    Task.prototype.table = 'task';</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">     * Setup</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">     * Create table</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">    Task.prototype.setup = function() {</td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">      var _this = this;</td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">      return this._createTable(function(table) {</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">        table.increments('id').unsigned();</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">        table.integer('userId').unsigned().index().references('id').inTable('user').onDelete('cascade').onUpdate('cascade').notNullable();</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">        table.integer('listId').unsigned().references('id').inTable('list').onDelete('cascade').onUpdate('cascade').notNullable();</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">        table.string('name', 150);</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">        table.string('notes', 400);</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">        table.integer('priority').unsigned();</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">        table.bigInteger('completed').unsigned();</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">        return table.bigInteger('date').unsigned();</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">    return Task;</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">  })(Table);</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">43</td><td class="hits">1</td><td class="source">  module.exports = Task;</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/database/user.coffee">/Volumes/Home/Projects/Nitro-Sync/app/database/user.coffee</h2><div id="stats" class="high"><div class="percentage">76%</div><div class="sloc">26</div><div class="hits">20</div><div class="misses">6</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var Table, User, _ref,</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">    __hasProp = {}.hasOwnProperty,</td></tr><tr class="hit"><td class="line">4</td><td class="hits">7</td><td class="source">    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  Table = require('../controllers/table');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">  User = (function(_super) {</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    __extends(User, _super);</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    function User() {</td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">      _ref = User.__super__.constructor.apply(this, arguments);</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">      return _ref;</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">    User.prototype.table = 'user';</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">     * Setup</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">     * Creates the `user` table if it doesn't already exist</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">    User.prototype.setup = function() {</td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">      var _this = this;</td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">      return this._createTable(function(table) {</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">        table.increments('id').unsigned();</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">        table.string('name', 100);</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">        table.string('email', 100).index();</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">        table.string('password', 60);</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">        table.boolean('pro').unsigned();</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">        return table.timestamp('created_at').defaultTo(_this.query.raw('now()'));</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">37</td><td class="hits">1</td><td class="source">    User.prototype.search = function(email) {</td></tr><tr class="hit"><td class="line">38</td><td class="hits">30</td><td class="source">      var promise;</td></tr><tr class="hit"><td class="line">39</td><td class="hits">30</td><td class="source">      promise = this._search('id', {</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        email: email</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">      });</td></tr><tr class="hit"><td class="line">42</td><td class="hits">30</td><td class="source">      return promise.then(function(rows) {</td></tr><tr class="hit"><td class="line">43</td><td class="hits">14</td><td class="source">        return rows[0].id;</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">47</td><td class="hits">1</td><td class="source">    return User;</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">  })(Table);</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">51</td><td class="hits">1</td><td class="source">  module.exports = User;</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/models/user.coffee">/Volumes/Home/Projects/Nitro-Sync/app/models/user.coffee</h2><div id="stats" class="high"><div class="percentage">99%</div><div class="sloc">102</div><div class="hits">101</div><div class="misses">1</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var Log, Q, User, db, log;</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">  Q = require('kew');</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  db = require('../controllers/query');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">  Log = require('../utils/log');</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">  log = Log('user', 'green');</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">  User = (function() {</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">     * Create a new User instance</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">     * - [attrs] (object) : optional attributes to load in</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">     * - [duration] (int) : how long to wait between writes</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">    var Storage;</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">    function User(id) {</td></tr><tr class="hit"><td class="line">23</td><td class="hits">79</td><td class="source">      this.id = id;</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">    module.exports = User;</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">    Storage = require('../controllers/storage');</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">    User.prototype.info = function() {</td></tr><tr class="hit"><td class="line">31</td><td class="hits">9</td><td class="source">      return db.user.read(this.id, ['name', 'email', 'pro']);</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">     * Set Name</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">     * - name (string) : the users name</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">41</td><td class="hits">1</td><td class="source">    User.prototype.setName = function(name) {</td></tr><tr class="hit"><td class="line">42</td><td class="hits">1</td><td class="source">      return db.user.update(this.id, {</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        name: name</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">47</td><td class="hits">1</td><td class="source">    User.prototype.getName = function() {</td></tr><tr class="hit"><td class="line">48</td><td class="hits">1</td><td class="source">      return db.user.read(this.id, 'name').then(function(info) {</td></tr><tr class="hit"><td class="line">49</td><td class="hits">1</td><td class="source">        return info.name;</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">     * Change a users email and update the email lookup table</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">     * - email (string) : the email to change to</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">60</td><td class="hits">1</td><td class="source">    User.prototype.setEmail = function(email) {</td></tr><tr class="hit"><td class="line">61</td><td class="hits">1</td><td class="source">      return db.user.update(this.id, {</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        email: email</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">66</td><td class="hits">1</td><td class="source">    User.prototype.getEmail = function() {</td></tr><tr class="hit"><td class="line">67</td><td class="hits">1</td><td class="source">      return db.user.read(this.id, 'email').then(function(info) {</td></tr><tr class="hit"><td class="line">68</td><td class="hits">1</td><td class="source">        return info.email;</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">     * Change a users password and remove all their login tokens</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">     * - password (string) : the hash of the password</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">79</td><td class="hits">1</td><td class="source">    User.prototype.setPassword = function(password) {</td></tr><tr class="hit"><td class="line">80</td><td class="hits">1</td><td class="source">      db.login.destroyAll(this.id);</td></tr><tr class="hit"><td class="line">81</td><td class="hits">1</td><td class="source">      return db.user.update(this.id, {</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">        password: password</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">86</td><td class="hits">1</td><td class="source">    User.prototype.getPassword = function() {</td></tr><tr class="hit"><td class="line">87</td><td class="hits">5</td><td class="source">      return db.user.read(this.id, 'password').then(function(info) {</td></tr><tr class="hit"><td class="line">88</td><td class="hits">5</td><td class="source">        return info.password;</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">92</td><td class="hits">1</td><td class="source">    User.prototype.createModel = function(classname, properties) {</td></tr><tr class="hit"><td class="line">93</td><td class="hits">43</td><td class="source">      return db[classname].create(properties);</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">96</td><td class="hits">1</td><td class="source">    User.prototype.createList = function(list) {</td></tr><tr class="hit"><td class="line">97</td><td class="hits">27</td><td class="source">      return this.createModel('list', {</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        userId: this.id,</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">        name: list.name</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">103</td><td class="hits">1</td><td class="source">    User.prototype.createTask = function(task) {</td></tr><tr class="hit"><td class="line">104</td><td class="hits">14</td><td class="source">      return this.createModel('task', {</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">        userId: this.id,</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">        listId: task.listId,</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">        name: task.name,</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">        notes: task.notes,</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">        date: task.date,</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">        priority: task.priority,</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">        completed: task.completed</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">115</td><td class="hits">1</td><td class="source">    User.prototype.createPref = function(pref) {</td></tr><tr class="hit"><td class="line">116</td><td class="hits">2</td><td class="source">      return this.createModel('pref', {</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">        userId: this.id,</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">        sort: pref.sort,</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">        night: pref.night,</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">        language: pref.language,</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">        weekStart: pref.weekStart,</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">        dateFormat: pref.dateFormat,</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">        confirmDelete: pref.confirmDelete,</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">        moveCompleted: pref.moveCompleted</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">128</td><td class="hits">1</td><td class="source">    User.prototype.addTaskToList = function(taskId, listId) {</td></tr><tr class="hit"><td class="line">129</td><td class="hits">8</td><td class="source">      return db.listTasks.create(listId, taskId);</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">132</td><td class="hits">1</td><td class="source">    User.prototype.removeTaskFromList = function(taskId, listId) {</td></tr><tr class="hit"><td class="line">133</td><td class="hits">2</td><td class="source">      return db.listTasks.destroy(listId, taskId);</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">136</td><td class="hits">1</td><td class="source">    User.prototype.readListTasks = function(listId) {</td></tr><tr class="hit"><td class="line">137</td><td class="hits">5</td><td class="source">      return db.listTasks.read(listId);</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">140</td><td class="hits">1</td><td class="source">    User.prototype.shouldOwnModel = function(classname, id) {</td></tr><tr class="hit"><td class="line">141</td><td class="hits">93</td><td class="source">      return db[classname]._search('id', {</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">        id: id,</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">        userId: this.id</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">147</td><td class="hits">1</td><td class="source">    User.prototype.shouldOwnTask = function(id) {</td></tr><tr class="hit"><td class="line">148</td><td class="hits">30</td><td class="source">      return this.shouldOwnModel('task', id).fail(function() {</td></tr><tr class="hit"><td class="line">149</td><td class="hits">21</td><td class="source">        log('[task] does not own', id);</td></tr><tr class="hit"><td class="line">150</td><td class="hits">21</td><td class="source">        throw 'err_no_row';</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">154</td><td class="hits">1</td><td class="source">    User.prototype.shouldOwnList = function(id) {</td></tr><tr class="hit"><td class="line">155</td><td class="hits">63</td><td class="source">      return this.shouldOwnModel('list', id).fail(function() {</td></tr><tr class="hit"><td class="line">156</td><td class="hits">36</td><td class="source">        log('[list] does not own', id);</td></tr><tr class="hit"><td class="line">157</td><td class="hits">36</td><td class="source">        throw 'err_no_row';</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">161</td><td class="hits">1</td><td class="source">    User.prototype.readModel = function(classname, id, columns) {</td></tr><tr class="hit"><td class="line">162</td><td class="hits">25</td><td class="source">      return db[classname].read(id, columns).then(function(obj) {</td></tr><tr class="hit"><td class="line">163</td><td class="hits">16</td><td class="source">        delete obj.userId;</td></tr><tr class="hit"><td class="line">164</td><td class="hits">16</td><td class="source">        return obj;</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">168</td><td class="hits">1</td><td class="source">    User.prototype.readList = function(id, columns) {</td></tr><tr class="hit"><td class="line">169</td><td class="hits">9</td><td class="source">      return this.readModel('list', id, columns);</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">172</td><td class="hits">1</td><td class="source">    User.prototype.readTask = function(id, columns) {</td></tr><tr class="hit"><td class="line">173</td><td class="hits">10</td><td class="source">      return this.readModel('task', id, columns);</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">176</td><td class="hits">1</td><td class="source">    User.prototype.readPref = function(columns) {</td></tr><tr class="hit"><td class="line">177</td><td class="hits">6</td><td class="source">      return this.readModel('pref', this.id, columns);</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">180</td><td class="hits">1</td><td class="source">    User.prototype.updateModel = function(classname, id, changes) {</td></tr><tr class="hit"><td class="line">181</td><td class="hits">44</td><td class="source">      return db[classname].update(id, changes);</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">184</td><td class="hits">1</td><td class="source">    User.prototype.updateList = function(id, changes) {</td></tr><tr class="hit"><td class="line">185</td><td class="hits">7</td><td class="source">      return this.updateModel('list', id, changes);</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">188</td><td class="hits">1</td><td class="source">    User.prototype.updateTask = function(id, changes) {</td></tr><tr class="hit"><td class="line">189</td><td class="hits">7</td><td class="source">      return this.updateModel('task', id, changes);</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">192</td><td class="hits">1</td><td class="source">    User.prototype.updatePref = function(changes) {</td></tr><tr class="hit"><td class="line">193</td><td class="hits">30</td><td class="source">      return this.updateModel('pref', this.id, changes);</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">196</td><td class="hits">1</td><td class="source">    User.prototype.destroyModel = function(classname, id) {</td></tr><tr class="hit"><td class="line">197</td><td class="hits">21</td><td class="source">      return db[classname].destroy(id);</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">200</td><td class="hits">1</td><td class="source">    User.prototype.destroyList = function(id) {</td></tr><tr class="hit"><td class="line">201</td><td class="hits">14</td><td class="source">      return this.destroyModel('list', id);</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">204</td><td class="hits">1</td><td class="source">    User.prototype.destroyTask = function(id) {</td></tr><tr class="hit"><td class="line">205</td><td class="hits">5</td><td class="source">      return this.destroyModel('task', id);</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">208</td><td class="hits">1</td><td class="source">    User.prototype.destroyPref = function() {</td></tr><tr class="hit"><td class="line">209</td><td class="hits">2</td><td class="source">      return this.destroyModel('pref', this.id);</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">     * Get an array of all the active models in a class</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">     *</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">     * - classname (string)</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">     * &gt; object</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">    */</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">220</td><td class="hits">1</td><td class="source">    User.prototype.exportTasks = function() {</td></tr><tr class="hit"><td class="line">221</td><td class="hits">7</td><td class="source">      return db.task._search('*', {</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">        userId: this.id</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">      }).then(function(tasks) {</td></tr><tr class="hit"><td class="line">224</td><td class="hits">6</td><td class="source">        var task, _i, _len;</td></tr><tr class="hit"><td class="line">225</td><td class="hits">6</td><td class="source">        for (_i = 0, _len = tasks.length; _i &lt; _len; _i++) {</td></tr><tr class="hit"><td class="line">226</td><td class="hits">19</td><td class="source">          task = tasks[_i];</td></tr><tr class="hit"><td class="line">227</td><td class="hits">19</td><td class="source">          delete task.userId;</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">229</td><td class="hits">6</td><td class="source">        return tasks;</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">      }).fail(function() {</td></tr><tr class="hit"><td class="line">231</td><td class="hits">1</td><td class="source">        return [];</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">235</td><td class="hits">1</td><td class="source">    User.prototype.exportLists = function() {</td></tr><tr class="hit"><td class="line">236</td><td class="hits">5</td><td class="source">      return db.list._search('*', {</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">        userId: this.id</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">      }).then(function(lists) {</td></tr><tr class="hit"><td class="line">239</td><td class="hits">5</td><td class="source">        var promises;</td></tr><tr class="hit"><td class="line">240</td><td class="hits">5</td><td class="source">        promises = [];</td></tr><tr class="hit"><td class="line">241</td><td class="hits">5</td><td class="source">        lists.forEach(function(list) {</td></tr><tr class="hit"><td class="line">242</td><td class="hits">18</td><td class="source">          delete list.userId;</td></tr><tr class="hit"><td class="line">243</td><td class="hits">18</td><td class="source">          return promises.push(db.listTasks.read(list.id).then(function(tasks) {</td></tr><tr class="hit"><td class="line">244</td><td class="hits">18</td><td class="source">            return list.tasks = tasks;</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">          }));</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source">        });</td></tr><tr class="hit"><td class="line">247</td><td class="hits">5</td><td class="source">        return Q.all(promises).then(function() {</td></tr><tr class="hit"><td class="line">248</td><td class="hits">5</td><td class="source">          return lists;</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">      }).fail(function() {</td></tr><tr class="miss"><td class="line">251</td><td class="hits">0</td><td class="source">        return [];</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">      });</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">255</td><td class="hits">1</td><td class="source">    User.prototype.exportPref = function() {</td></tr><tr class="hit"><td class="line">256</td><td class="hits">2</td><td class="source">      return this.readPref();</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">259</td><td class="hits">1</td><td class="source">    return User;</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">  })();</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/utils/keychain.coffee">/Volumes/Home/Projects/Nitro-Sync/app/utils/keychain.coffee</h2><div id="stats" class="high"><div class="percentage">75%</div><div class="sloc">16</div><div class="hits">12</div><div class="misses">4</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var Log, data, e, fs, keys, warn;</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">  Log = require('../utils/log');</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">  fs = require('fs');</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">  keys = {};</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">  warn = Log('Keychain', 'red');</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">  try {</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">    data = fs.readFileSync(__dirname + '/../../keychain');</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">  } catch (_error) {</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">    e = _error;</td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">    warn('Could not load keychain');</td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">    data = '{}';</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">  }</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">  keys = JSON.parse(data.toString());</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">  module.exports = function(key) {</td></tr><tr class="hit"><td class="line">23</td><td class="hits">6</td><td class="source">    if (!keys.hasOwnProperty(key)) {</td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">      warn(&quot;Key not found for '&quot; + key + &quot;'&quot;);</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">26</td><td class="hits">6</td><td class="source">    return keys[key];</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/utils/log.coffee">/Volumes/Home/Projects/Nitro-Sync/app/utils/log.coffee</h2><div id="stats" class="high"><div class="percentage">92%</div><div class="sloc">13</div><div class="hits">12</div><div class="misses">1</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var colors,</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">    __slice = [].slice;</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">  colors = {</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">    'reset': '\u001b[0m',</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">    'bold': '\u001b[1m',</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">    'italic': '\u001b[3m',</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">    'underline': '\u001b[4m',</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">    'blink': '\u001b[5m',</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">    'black': '\u001b[30m',</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">    'red': '\u001b[31m',</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    'green': '\u001b[32m',</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    'yellow': '\u001b[33m',</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    'blue': '\u001b[34m',</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    'magenta': '\u001b[35m',</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    'cyan': '\u001b[36m',</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    'white': '\u001b[37m'</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">  module.exports = function(name, color) {</td></tr><tr class="hit"><td class="line">22</td><td class="hits">9</td><td class="source">    var prefix,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">      _this = this;</td></tr><tr class="hit"><td class="line">24</td><td class="hits">9</td><td class="source">    if (color == null) {</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">      color = 'reset';</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    }</td></tr><tr class="hit"><td class="line">27</td><td class="hits">9</td><td class="source">    prefix = &quot;&quot; + colors[color] + &quot;[&quot; + name + &quot;]&quot; + colors.reset;</td></tr><tr class="hit"><td class="line">28</td><td class="hits">9</td><td class="source">    return function() {</td></tr><tr class="hit"><td class="line">29</td><td class="hits">111</td><td class="source">      var args;</td></tr><tr class="hit"><td class="line">30</td><td class="hits">111</td><td class="source">      args = 1 &lt;= arguments.length ? __slice.call(arguments, 0) : [];</td></tr><tr class="hit"><td class="line">31</td><td class="hits">111</td><td class="source">      args.unshift(prefix);</td></tr><tr class="hit"><td class="line">32</td><td class="hits">111</td><td class="source">      return console.log.apply(console, args);</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">  };</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Volumes/Home/Projects/Nitro-Sync/app/utils/time.coffee">/Volumes/Home/Projects/Nitro-Sync/app/utils/time.coffee</h2><div id="stats" class="low"><div class="percentage">36%</div><div class="sloc">50</div><div class="hits">18</div><div class="misses">32</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">(function() {</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">  var BASE, TIME, Time,</td></tr><tr class="hit"><td class="line">3</td><td class="hits">124</td><td class="source">    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">  BASE = 1388487600000;</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">  TIME = 'time';</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">  Time = (function() {</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    function Time(user) {</td></tr><tr class="hit"><td class="line">11</td><td class="hits">31</td><td class="source">      this.user = user;</td></tr><tr class="hit"><td class="line">12</td><td class="hits">31</td><td class="source">      this.check = __bind(this.check, this);</td></tr><tr class="hit"><td class="line">13</td><td class="hits">31</td><td class="source">      this.set = __bind(this.set, this);</td></tr><tr class="hit"><td class="line">14</td><td class="hits">31</td><td class="source">      this.clear = __bind(this.clear, this);</td></tr><tr class="hit"><td class="line">15</td><td class="hits">31</td><td class="source">      this.get = __bind(this.get, this);</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">    Time.prototype.get = function(className, id, attr) {</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">      var time, _ref, _ref1;</td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">      time = (_ref = this.user.findModel(TIME, className)) != null ? (_ref1 = _ref[id]) != null ? _ref1[attr] : void 0 : void 0;</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">      if (time) {</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">        time += BASE;</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">      return time;</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">    Time.prototype.clear = function(className, id) {</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">      delete this.user.findModel(TIME, className)[id];</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">      return id;</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">32</td><td class="hits">1</td><td class="source">    Time.prototype.set = function(className, id, attr, time) {</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">      var key, _base;</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">      if (typeof attr === 'object') {</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">        for (key in attr) {</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">          time = attr[key];</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">          this.set(className, id, key, time);</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">        return;</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">      time -= BASE;</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">      if ((_base = this.user.findModel(TIME, className))[id] == null) {</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">        _base[id] = {};</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">      if (attr === '*') {</td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="source">        for (attr in this.user.findModel(className, id)) {</td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="source">          if (attr === 'id') {</td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="source">            continue;</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">          }</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">          this.user.data(TIME)[className][id][attr] = time;</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">      } else {</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">        this.user.data(TIME)[className][id][attr] = time;</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">      this.user.save(TIME);</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">58</td><td class="hits">1</td><td class="source">    Time.prototype.check = function(className, id, time) {</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">      var attr, pass, val, _ref;</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">      if (((_ref = this.user.findModel(TIME, className)) != null ? _ref[id] : void 0) == null) {</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">        return;</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">      pass = true;</td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">      for (attr in this.user.findModel(TIME, className)[id]) {</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">        val = this.get(className, id, attr);</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">        if (val &gt; time) {</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">          pass = false;</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">      }</td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="source">      return pass;</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">73</td><td class="hits">1</td><td class="source">    return Time;</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">  })();</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">77</td><td class="hits">1</td><td class="source">  module.exports = Time;</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">}).call(this);</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div></div></div></body></html>